# å¾é›¶é–‹å§‹æ­å»ºå®¶åº­é«˜å¯ç”¨è¶…èåˆæ•¸æ“šä¸­å¿ƒ

æ•…äº‹å¾å»å¹´é–‹å§‹ï¼Œå› ç‚ºè¶Šä¾†è¶Šå¤šçš„æ•¸æ“šå­˜å„²å’Œ AI è¨ˆç®—éœ€æ±‚ï¼Œæˆ‘é–‹å§‹é‡æ–°çµ„ç¹”å®¶è£çš„è¨ˆç®—è³‡æºï¼ŒæŠŠé›¶æ•£çš„è¨ˆç®—è³‡æºæ•´åˆæˆæ›´ä¾¿æ–¼ç®¡ç†å’Œç¶­è­·çš„çµ±ä¸€è³‡æºæ¶æ§‹ã€‚é™¸é™¸çºŒçºŒæŠ˜é¨°äº†ä¸€æ®µæ™‚é–“ï¼Œåœ¨é€™å€‹éç¨‹ä¸­ï¼Œæˆ‘é‡åˆ°äº†å¾ˆå¤šçš„å•é¡Œï¼Œä¹‹å‰ä¹Ÿåœ¨ X ä¸Šä¹Ÿå’Œå¤§å®¶åˆ†äº«éä¸€äº›ï¼Œå¤§å®¶å»ºè­°æˆ‘éƒ½å¯«ä¸‹ä¾†ï¼Œç¶“éä¸€äº›è€ƒæ…®ï¼Œæˆ‘æ±ºå®šæˆé«”ç³»åœ°ä»‹ç´¹ä¸€ä¸‹å¦‚ä½•ä¸€æ­¥ä¸€æ­¥æ­å»ºé©åˆå®¶åº­ç¶²çµ¡è¦æ¨¡çš„`é«˜å¯ç”¨è¶…èåˆæ•¸æ“šä¸­å¿ƒ`ã€‚

ç•¶ç„¶äº†ï¼Œèªª`æ•¸æ“šä¸­å¿ƒ`æ˜¯ä¸€å€‹èª‡å¤§çš„æ¦‚å¿µï¼Œä½†æ˜¯é€™å€‹éç¨‹çš„ç¢ºå·²ç¶“è¦†è“‹äº†æ­å»ºä¸€å€‹å°å‹æ•¸æ“šä¸­å¿ƒæ‰€éœ€è¦çš„å¸¸è¦‹é¡åˆ¥çš„è¨­å‚™å’Œæ¯”è¼ƒå®Œæ•´çš„æ­¥é©Ÿã€‚æœ¬æ–‡æœƒæœ‰ä¸€äº›è¨­å‚™é¸å‹ä¸Šçš„è€ƒæ…®ï¼Œä¹Ÿæœƒæœ‰å¾ˆå¤šé…ç½®ä¸Šçš„ç´°ç¯€ï¼Œä¸ä¸€å®šå¾ˆæœ‰å«é‡‘é‡ï¼Œä½†æ±‚çµ¦å¤§å®¶ä¸€äº›åƒè€ƒã€‚æˆ‘å°‡æœƒå¾ç¶²çµ¡æ­å»ºé–‹å§‹ï¼Œè¬›åˆ°å­˜å„²ï¼Œå†åˆ°è™›æ“¬åŒ–ï¼Œå› ç‚ºæˆ‘è¦ºå¾—è€ƒæ…® homelab çš„é…ç½®ï¼Œæ‡‰è©²éµå¾ªé€™ä¸€å€‹é †åºï¼Œé¿å…ä¾†å›æŠ˜é¨°ï¼Œæµªè²»æ™‚é–“ã€‚

## ä»€éº¼æ˜¯è¶…èåˆ

é—œæ–¼æ•¸æ“šä¸­å¿ƒå¦‚ä½•å¾`å‚³çµ±æ¶æ§‹`æ¼”é€²åˆ°`èåˆæ¶æ§‹`å†åˆ°`è¶…èåˆæ¶æ§‹`ï¼Œå¯ä»¥ç°¡å–®éä¸€ä¸‹[é€™å€‹è¦–é »](https://www.youtube.com/watch?v=xZvLvKv1rjs)ã€‚ç°¡å–®ä¾†èªªï¼Œåœ¨å‚³çµ±çš„æ•¸æ“šä¸­å¿ƒï¼Œæœå‹™å™¨ç¯€é»ä¸€èˆ¬åˆ†ç‚ºä¸‰å¤§é¡åˆ¥ï¼Œç¶²çµ¡æœå‹™å™¨ï¼Œå­˜å„²æœå‹™å™¨ï¼Œæ‡‰ç”¨æœå‹™å™¨ï¼š

- ç¶²çµ¡æœå‹™å™¨åŒ…æ‹¬å…‰é›»ç·šè·¯çš„è·¯ç”±å™¨ï¼Œé˜²ç«ç‰†ï¼Œäº¤æ›æ©Ÿï¼ŒIoT ç¶²é—œç­‰ç­‰ï¼›
- å­˜å„²æœå‹™å™¨å¾€å¾€ä»¥é›†ç¾¤çš„æ–¹å¼å­˜åœ¨ï¼Œå°æ‡‰ç”¨æœå‹™å™¨æä¾›å†·ç†±æ•¸æ“šçš„è¨ªå•ï¼ŒäºŒé€²åˆ¶æ•¸æ“šå’Œçµæ§‹åŒ–æ•¸æ“šçš„å­˜å„²ã€å‚™ä»½ç­‰ç­‰ï¼Œæœ‰å¤šæ–¹å¼å¯¦æ–½ï¼Œå¦‚ NASï¼ŒSANï¼ŒDAS ç­‰å‹æ…‹ï¼›
- æ‡‰ç”¨æœå‹™å™¨æ‰¿æ“”è‘—è¦çš„è¨ˆç®—ä»»å‹™ï¼ŒåŒ…æ‹¬ CPU ç‚ºä¸»çš„é‹ç®—ä»¥åŠæ–°èˆˆçš„ GPU ç‚ºä¸»çš„é‹ç®—ï¼Œæä¾›çš„æœå‹™åŒ…æ‹¬ Web æœå‹™ï¼Œéƒµä»¶æœå‹™ï¼Œè™›æ“¬æ©Ÿï¼Œå®¹å™¨é›†ç¾¤ï¼Œå¯†é›†è¨ˆç®—æœå‹™ç­‰ç­‰ã€‚

![HCI](./assets/Hyperconvergence.jpg)

è¶…èåˆ[HCI (Hyper-Converged Infrastructure)](https://en.wikipedia.org/wiki/Hyper-converged_infrastructure)çš„æ¦‚å¿µæ¯”è¼ƒæ–°ï¼Œå®ƒæ˜¯éš¨è‘—è™›æ“¬åŒ–çš„ç™¼å±•è€Œæå‡ºä¾†çš„ä¸€é‡æ–°`çµ„ç¹”æœå‹™å™¨è³‡æºçš„ç­–ç•¥`ï¼Œä¹Ÿæ˜¯æ‰€è¬‚`è»Ÿä»¶å®šç¾©æ•¸æ“šä¸­å¿ƒ`çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ã€‚è¶…èåˆæ•¸æ“šä¸­å¿ƒå°‡ç¶²çµ¡ï¼ˆéƒ¨åˆ†ï¼‰ï¼Œå­˜å„²ï¼Œé‹ç®—ä¸‰ç¨®è³‡æºèåˆåœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€å€‹çµ±ä¸€çš„è³‡æºæ± ï¼Œå®Œå…¨ç”±è™›æ“¬åŒ–å¹³å°æä¾›å„ç¨®è¨ˆç®—å’Œå­˜å„²è³‡æºã€‚

åœ¨ä¸€å€‹è¶…èåˆè¨ˆç®—ä¸­å¿ƒè£¡é¢ï¼Œé™¤äº†ç‰©ç†ä¸»æ©Ÿçš„ç¶²çµ¡é€£æ¥éœ€è¦å–®ç¨çš„ç¶²çµ¡è¨­å‚™ä¹‹å¤–ï¼Œå…¶ä»–çš„è³‡æºéƒ½å¯ä»¥é€šéè™›æ“¬åŒ–å¹³å°ä¾†æä¾›ï¼Œæ¯å€‹ç‰©ç†ä¸»æ©Ÿéƒ½æ˜¯å…¨èƒ½ç¯€é»ï¼Œæ‰¿æ“”éƒ¨åˆ†çš„è¨ˆç®—å’Œå­˜å„²ï¼Œä»–å€‘ä¹‹é–“`ç·Šå¯†ç›¸é€£`ï¼Œ`è³‡æºå…±äº«`ï¼Œ`ç›¸äº’å‚™æ´`ã€‚è¶…èåˆä¸æ˜¯ä¸€å€‹ç‰¹å®šçš„å–®ä¸€è»Ÿä»¶æŠ€è¡“ï¼Œå®ƒå…¶å¯¦è„«èƒæ–¼è™›æ“¬åŒ–ã€åˆ†ä½ˆå¼å­˜å„²ç­‰ä¸€ç³»åˆ—æŠ€è¡“ä¸Šçš„æ¦‚å¿µã€‚åœ¨å¯¦æ–½ä¸Šï¼Œå¸¸è¦‹çš„è¶…èæŠ€è¡“æ£§æœ‰ [PVE (Proxmox VE)](https://www.proxmox.com/en/proxmox-ve) + [Ceph](https://ceph.io), [VMware vSphere](https://www.vmware.com/products/cloud-infrastructure/vsphere), [Hyper-V](https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/hyper-v-overview) + [S2D](https://learn.microsoft.com/en-us/system-center/vmm/s2d-hyper-converged?view=sc-vmm-2025&tabs=HyperVhosts) ç­‰ç­‰ã€‚æœ¬æ–‡ä»¥ PVE + Ceph ç‚ºä¾‹å­ï¼Œå…¶ä»–æ–¹æ¡ˆçš„åŒ…è£å¯èƒ½æœ‰å·®ç•°ï¼Œä½†æ˜¯åŸç†æ˜¯ç›¸é€šçš„ã€‚

## å¾æ©Ÿæ«ƒé–‹å§‹

æ¥ä¸‹ä¾†æˆ‘æœƒä»‹ç´¹ä¸€äº›æˆ‘é¸ç”¨çš„ç¡¬ä»¶ï¼Œæ²’æœ‰ä»»ä½•å»£å‘Šçš„æˆåˆ†ï¼Œå› ç‚º X ä¸Šå¾ˆå¤šäººå°æˆ‘ç”¨çš„è¨­å‚™æ„Ÿèˆˆè¶£ï¼Œé€™è£¡ç°¡å–®ä»‹ç´¹ä¸€ä¸‹ä¸€äº›åŸºç¤çš„é¸å‹æ€è·¯ã€‚

é¦–å…ˆè¦æœ‰ä¸€å€‹æ©Ÿæ«ƒã€‚é¸å‹ä¸Šï¼Œé™¤äº†é€šé¢¨è¨­è¨ˆçš„è€ƒæ…®ä¹‹å¤–ï¼Œæˆ‘èªç‚ºé¦–å…ˆè¦æ¸¬é‡ä¸€ä¸‹è¨ˆç•«å­˜æ”¾çš„æˆ¿é–“æˆ–è€…åœ°ä¸‹å®¤çš„é«˜åº¦ï¼Œåœ¨èƒ½å®¹ç´çš„é«˜åº¦ç¯„åœå…§é¸æ“‡ä¸€å€‹æœ€é«˜çš„ã€‚é«˜åº¦æ±ºå®šäº†é€™å¥—è¨­å‚™å°‡ä¾†çš„æ“´å±•æ€§ï¼Œä¸è¦çŒ¶è±«ï¼Œè¶Šé«˜è¶Šå¥½ã€‚æˆ‘çš„åœ°ä¸‹å®¤æœ‰ä¸€æ ¹æ‡¸æ¢ï¼Œé™åˆ¶äº†æœ€å¤§é«˜åº¦ï¼Œæ‰€ä»¥åªèƒ½é¸æ“‡çš„æœ€å¤§ 32U çš„ï¼Œå…·é«”æ˜¯é€™æ¬¾ï¼š[StarTech.com 4-Post 32U Server Rack Cabinet](https://www.amazon.ca/dp/B099986PZF?ref_=ppx_hzsearch_conn_dt_b_fed_asin_title_5&th=1)ã€‚

ä¸‹é¢é€™å€‹è¡¨åˆ—å‡ºäº†å¤šå°‘ Unit çš„æ«ƒå­å¤§æ¦‚æœ‰å¤šå°‘é«˜åº¦ï¼Œç¯„åœå¾ 1U åˆ° 48Uï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨[é€™å€‹é é¢](https://www.penn-elcom.com/ca/rack-unit-calculator)ä¸Šå‹•æ…‹ä¼°ç®—ã€‚

| Rack Units | Height (in) | Height (ft) | Height (cm) |
|------------|------------|------------|------------|
| 1U         | 1.75â€³      | 0.15â€²      | 4.4 cm     |
| 2U         | 3.5â€³       | 0.29â€²      | 8.9 cm     |
| 3U         | 5.25â€³      | 0.44â€²      | 13.3 cm    |
| 4U         | 7â€³         | 0.58â€²      | 17.8 cm    |
| 5U         | 8.75â€³      | 0.73â€²      | 22.2 cm    |
| 6U         | 10.5â€³      | 0.88â€²      | 26.7 cm    |
| 7U         | 12.25â€³     | 1.02â€²      | 31.1 cm    |
| 8U         | 14â€³        | 1.17â€²      | 35.6 cm    |
| 9U         | 15.75â€³     | 1.31â€²      | 40 cm      |
| 10U        | 17.5â€³      | 1.46â€²      | 44.5 cm    |
| 11U        | 19.25â€³     | 1.6â€²       | 48.9 cm    |
| 12U        | 21â€³        | 1.75â€²      | 53.3 cm    |
| 13U        | 22.75â€³     | 1.9â€²       | 57.8 cm    |
| 14U        | 24.5â€³      | 2.04â€²      | 62.2 cm    |
| 15U        | 26.25â€³     | 2.19â€²      | 66.7 cm    |
| 16U        | 28â€³        | 2.33â€²      | 71.1 cm    |
| 17U        | 29.75â€³     | 2.48â€²      | 75.6 cm    |
| 18U        | 31.5â€³      | 2.63â€²      | 80 cm      |
| 19U        | 33.25â€³     | 2.77â€²      | 84.5 cm    |
| 20U        | 35â€³        | 2.92â€²      | 88.9 cm    |
| 21U        | 36.75â€³     | 3.06â€²      | 93.3 cm    |
| 22U        | 38.5â€³      | 3.21â€²      | 97.8 cm    |
| 23U        | 40.25â€³     | 3.35â€²      | 102.2 cm   |
| 24U        | 42â€³        | 3.5â€²       | 106.7 cm   |
| 25U        | 43.75â€³     | 3.65â€²      | 111.1 cm   |
| 26U        | 45.5â€³      | 3.79â€²      | 115.6 cm   |
| 27U        | 47.25â€³     | 3.94â€²      | 120 cm     |
| 28U        | 49â€³        | 4.08â€²      | 124.5 cm   |
| 29U        | 50.75â€³     | 4.23â€²      | 128.9 cm   |
| 30U        | 52.5â€³      | 4.38â€²      | 133.4 cm   |
| 31U        | 54.25â€³     | 4.52â€²      | 137.8 cm   |
| 32U        | 56â€³        | 4.67â€²      | 142.2 cm   |
| 33U        | 57.75â€³     | 4.81â€²      | 146.7 cm   |
| 34U        | 59.5â€³      | 4.96â€²      | 151.1 cm   |
| 35U        | 61.25â€³     | 5.1â€²       | 155.6 cm   |
| 36U        | 63â€³        | 5.25â€²      | 160 cm     |
| 37U        | 64.75â€³     | 5.4â€²       | 164.5 cm   |
| 38U        | 66.5â€³      | 5.54â€²      | 168.9 cm   |
| 39U        | 68.25â€³     | 5.69â€²      | 173.4 cm   |
| 40U        | 70â€³        | 5.83â€²      | 177.8 cm   |
| 41U        | 71.75â€³     | 5.98â€²      | 182.2 cm   |
| 42U        | 73.5â€³      | 6.13â€²      | 186.7 cm   |
| 43U        | 75.25â€³     | 6.27â€²      | 191.1 cm   |
| 44U        | 77â€³        | 6.42â€²      | 195.6 cm   |
| 45U        | 78.75â€³     | 6.56â€²      | 200 cm     |
| 46U        | 80.5â€³      | 6.71â€²      | 204.5 cm   |
| 47U        | 82.25â€³     | 6.85â€²      | 208.9 cm   |
| 48U        | 84â€³        | 7â€²         | 213.4 cm   |

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ«ƒå­æœƒæœ‰ä¸Šè“‹å’Œåº•åº§ï¼Œæœ‰ä¸€äº›åº•åº§ä¸‹é¢é‚„æœ‰è¼ªå­ï¼Œæ‰€ä»¥ä¸€å®šè¦æ ¹æ“šè‡ªå·±çš„å¯¦éš›éœ€æ±‚ä¾†é¸æ“‡ï¼Œä¸¦ä¸”å¤šåšå¹¾æ¬¡æ¸¬é‡é¿å…å°·å°¬ï¼Œå› ç‚ºè¦é€€æ›çš„è©±ï¼Œå°‡æœƒéå¸¸éº»ç…©ï¼Œä¸€å€‹æ¯”è¼ƒæ­£å¼çš„å¹¾æ¶ï¼Œæ˜¯ç›¸ç•¶é‡çš„ã€‚

### æ©Ÿå™¨ä¸Šæ¶

æˆ‘å€‘æ¥ä¸‹ä¾†æœƒæŒ‘é¸ä¸€äº›è¨­å‚™ï¼Œå¾ç¶²çµ¡è¨­å‚™å‡ºç™¼ï¼Œä½†æ˜¯å°æ–¼å¾Œé¢å„ç¨®é¡å‹çš„è¨­å‚™åœ¨æ’å…¥æ©Ÿæ«ƒä¹‹å‰ï¼Œéƒ½éœ€è¦å¤§è‡´è€ƒæ…®å¥½æ©Ÿå™¨çš„æ“ºæ”¾é †åºï¼Œæ‰€ä»¥æˆ‘å€‘å…ˆç°¡å–®äº†è§£ä¸€ä¸‹ä¸Šæ¶æ©Ÿå™¨çš„ä¸€äº›åŸºæœ¬æº–å‰‡ï¼š

- é‡çš„æ©Ÿå™¨å¾€ä¸‹æ”¾ï¼Œä¸»è¦æ˜¯å­˜å„²å’Œ UPS ç­‰ï¼›
- è¼•çš„æ©Ÿå™¨å¾€ä¸Šæ”¾ï¼Œä¸»è¦æ˜¯é›»æºç®¡ç†ï¼Œç¶²çµ¡è¨­å‚™ï¼Œè¼”åŠ©è¨­å‚™ï¼ŒKVM ç­‰ï¼›
- å¤ªç†±çš„æ©Ÿå™¨ä¸è¦æ”¾åœ¨ä¸€èµ·ï¼Œè¦æœ‰é–“éš”ï¼Œç›¡å¯èƒ½è®“ç†±çš„æ©Ÿå™¨é è¿‘é¢¨æ‰‡é˜²æ­¢æ©Ÿæ©Ÿç©ç†±ï¼›
- æ ¹æ“šè‡ªå·±çš„èº«é«˜å’Œç¶­è­·ç¿’æ…£å®‰æ’ KVM çš„ä½ç½®ï¼Œå¤§æ¦‚ç‡å¯èƒ½æœƒè¢«å®‰æ’åœ¨æ©Ÿæ«ƒçš„ä¸­ä¸Šéƒ¨åˆ†ï¼›
- ç›¡å¯èƒ½å¤šå®‰æ’é¢¨æ‰‡ï¼Œä¿æŒé€šé¢¨ï¼Œå¯ä»¥å¤§å¤§æ¸›å°‘æ©Ÿå™¨å› ç‚ºç©ç†±å¸¶ä¾†çš„ç©©å®šæ€§å•é¡Œï¼Œé¢¨é“è¨­è¨ˆä¸Šï¼Œæ‡‰è©²å¾ä¸‹å¾€ä¸Šï¼Œå¾å‰å¾€å¾Œï¼Œæ¯”è¼ƒç´°ç·»çš„å¯ä»¥ä¸Šè‡ªå‹•æ§æº«è¨­å‚™ã€‚

é€™è£¡å¼•ç”¨ä¸€å€‹æ¯”è¼ƒç†æƒ³æƒ…æ³ä¸‹çš„[å–®æ«ƒæ’åˆ—ç­–ç•¥åœ–](https://lucid.app/lucidchart/c67227d4-dbd8-4164-9005-24aabf8a3765/view?anonId=0.07fd85c819500992984&sessionDate=2025-02-13T18%3A36%3A39.778Z&sessionId=0.e8ca132219500992985&fromMarketing=true&page=0_0#
)ï¼š

![å–®æ«ƒæ’åˆ—ç­–ç•¥åœ–](./assets/Screenshot%202025-02-13%20at%201.37.05â€¯PM.png)

ğŸ”” éœ€è¦æ³¨æ„ï¼Œå…¶å¯¦æ¯å€‹æ«ƒå­çš„å¯¦éš›æƒ…æ³éƒ½æ˜¯ä¸ä¸€æ¨£çš„ï¼Œéä¸€é«”åŒ–è¨­è¨ˆçš„æ©Ÿæ«ƒå–®å…ƒï¼Œå¾ˆå¤šæ™‚å€™æœƒå› ç‚ºç·šçºœé•·åº¦çš„åˆ¶ç´„ï¼Œèµ°ç·šçš„éœ€è¦ï¼Œæ©Ÿå™¨çš„å°ºå¯¸ã€é‡é‡ï¼Œç”šè‡³å€‹äººçš„å–œå¥½è€Œæœ‰æ‰€èª¿æ•´ï¼Œé€™éƒ½å¾ˆå¸¸è¦‹ï¼Œäº‹å¯¦ä¸Šéš¨è‘—æ¥­å‹™çš„è®ŠåŒ–ï¼Œæˆ‘ä¹Ÿèª¿æ•´éå¹¾æ¬¡æ‰é”åˆ°æ»¿æ„çš„æ•ˆæœã€‚

## ç¶²çµ¡è¦åŠƒ

ç¶²çµ¡è¨­å‚™çš„é¸æ“‡ä¸Šï¼Œé¦–å…ˆè¦è€ƒæ…®çš„æ˜¯é€Ÿç‡ä¸Šçš„è¦åŠƒã€‚æˆ‘å»ºè­°æ‰€æœ‰ç”¨æˆ¶ï¼Œéƒ½å¾ 10GE é–‹å§‹è€ƒæ…®ï¼Œä½æ–¼ 10GE çš„è¨­å‚™ï¼Œå¼·çƒˆä¸å»ºè­°è³¼è²·äº†ã€‚æœ‰æ¢ä»¶çš„è©±ï¼Œ40GE æˆ–è€… 100GE éƒ½å¯ä»¥è€ƒæ…®ã€‚

å¦ä¸€é»å°±æ˜¯è€ƒæ…®å‚³çµ± RJ45 é›»å£é‚„æ˜¯ SFP/SFP+/SFP28/QSFP+/QSFP28 ç­‰å…‰æ¨¡å¡Šæ¥å£ã€‚åœ¨é€™å€‹å•é¡Œä¸Šï¼Œæˆ‘è€ƒæ…®äº†å¾ˆä¹…ï¼Œä¸»è¦çš„åŸå› æ˜¯ï¼Œæˆ‘å·²ç¶“æœ‰ä¸€éƒ¨åˆ†çš„è¨­å‚™å·²ç¶“æ˜¯ 10GE é›»æ¥å£çš„ï¼Œå¦‚æœæˆ‘é¸æ“‡ SFP+ è·¯ç·šï¼Œæˆ‘å°‡ç„¡æ³•å…¼å®¹å·²æœ‰çš„è¨­å‚™ã€‚ä½†æ˜¯ 10G ä»¥ä¸Šé›»å£åœ¨æˆ‘ä¹‹å‰çš„ä½¿ç”¨ä¸­ï¼Œçš„ç¢ºé‡åˆ°ä¸€äº›å•é¡Œï¼Œç¶²å¡è¼‰è·å¤§ï¼Œç™¼ç†±é«˜ï¼Œæˆ‘çš„ç¢ºæƒ³è¶æ©Ÿæœƒæ¼”é€²åˆ°å…‰å£è·¯ç·šã€‚åœ¨èŠ±äº†å¾ˆå¤šæ™‚é–“è€ƒé‡ï¼Œæœ€å¾Œæ±ºå®šéƒ½è¦æœ‰ï¼Œäº‹å¯¦ä¸Šåˆ°ç›®å‰ç‚ºæ­¢ï¼Œæˆ‘ä¾ç„¶è¦ºå¾—é€™æ˜¯ä¸€å€‹æ­£ç¢ºçš„æ±ºå®šï¼Œç›®å‰çš„ç¶²çµ¡å®¹é‡å’Œéˆæ´»æ€§è®“æˆ‘åœ¨å·¥ä½œä¸­ç²å¾—äº†å¾ˆå¤§çš„å½ˆæ€§ï¼Œä¸¦é ç•™äº†è¶³å¤ çš„æ€§èƒ½ç©ºé–“ã€‚

### æˆ‘é¸ç”¨çš„è¨­å‚™

- èšåˆäº¤æ›æ©Ÿ [UniFi USW-Pro-Aggregation](https://ca.store.ui.com/ca/en/products/usw-pro-aggregation)
    > æ­£å¦‚æˆ‘å‰é¢èªªçš„ï¼Œæˆ‘éœ€è¦æœ‰è¶³å¤ çš„é›»å£å’Œå…‰å£ï¼Œå¯ç®¡ç†ï¼Œå¯å †ç–Šï¼Œå¯æ“´å±•ï¼Œé«˜æ€§èƒ½ï¼Œç©©å®šå¯é çš„äº¤æ›æ©Ÿä½œç‚ºæ ¸å¿ƒç¶²çš„åŸºç¤ã€‚é€™æ¬¾äº¤æ›æ©Ÿæœ‰ 32 å€‹ 28 å€‹ 10G SFP+ æ¥å£å’Œ 4 å€‹ 25G SFP28 æ¥å£ï¼Œäº¤æ›å®¹é‡æ˜¯ 760Gbpsï¼Œéé˜»å¡ IO èƒ½åˆ° 380 Gbpsï¼Œæ”¯æŒ VLANs å’Œéˆè·¯èšåˆï¼ŒLayer 3 å’Œ Layer 2 éƒ½æ˜¯å¯ç®¡ç†çš„ã€‚

- ä»¥å¤ªç¶²äº¤æ›æ©Ÿ[UniFi USW-EnterpriseXG-24](https://ca.store.ui.com/ca/en/products/usw-enterprisexg-24)
    > æˆ‘ä½¿ç”¨é€™ä¸€æ¬¾äº¤æ›æ©Ÿä¾†å…¼å®¹åŸæœ‰çš„è¨­å‚™ï¼Œæ”¯æŒ Wi-Fi ç†±é»ã€é ç¨‹ KVMã€æ™ºèƒ½å®¶å±…ç­‰å‚³çµ±é›»å£ç¶²çµ¡è¨­å‚™ã€‚å®ƒæœ‰ 24 å€‹ 10G RJ45 é›»å£å’Œ 2 å€‹ 25G SFP28 å…‰å£ï¼Œäº¤æ›å®¹é‡æ˜¯ 580Gbpsï¼Œéé˜»å¡ IO èƒ½åˆ° 290Gbpsï¼ŒåŒæ¨£æ”¯æŒ VLANsï¼Œ Layer 3 å’Œ Layer 2 å¯ç®¡ç†ã€‚

- å…¥å£è·¯ç”±/é˜²ç«ç‰† [UniFi Dream Machine Special Edition (UDM-SE 180W)](https://ca.store.ui.com/ca/en/products/udm-se)
    > é€™æ¬¾è¨­å‚™æœ‰ä¸€å€‹ 10G SFP+ Uplink ä½œç‚ºä¸»è¦å…¥å£ï¼Œä¸€å€‹ 2.5G RJ45 Uplink ä½œç‚ºå‚™ç”¨ç¶²çµ¡å…¥å£ï¼Œæœ‰ 1 å€‹ 10G SFP+ Downlink å’Œ 8 å€‹ GE RJ45 Downlinkï¼Œå…¶ä¸­ 2 å€‹é›»å£æ”¯æŒ PoE+ï¼Œ å…¶é¤˜ 6 å€‹æ˜¯é›»å£éƒ½æ”¯æŒ PoEã€‚å®ƒå”¯ä¸€è®“æˆ‘ä¸æ»¿æ„çš„æ˜¯ Uplink åªé–‹æ”¾äº† 3.5Gbpsï¼Œé›–ç„¶æˆ‘åªæœ‰ 3Gbps å°ç­‰å…‰ç·šæ¥å…¥ï¼Œçš„ç¢ºå·²ç¶“è¶³å¤ ï¼Œä½†æ˜¯ç¸½è¦ºå¾—é¤˜é‡ä¸è¶³ï¼Œæ¯”è¼ƒæ‡Šæ‚”çš„æ˜¯ï¼Œæˆ‘ä¸‹å–®ä¸ä¹…[Dream Machine Pro Max (UDM-Pro-Max)](https://ca.store.ui.com/ca/en/category/cloud-gateways-large-scale/products/udm-pro-max) å°±ä¸Šå¸‚äº†ï¼Œå®ƒçš„ Uplink èƒ½åˆ° 5 Gbpsï¼Œå°±å¥½ä¸å°‘ã€‚

### ä¸»è¦ç¶²çµ¡è¨­å‚™çš„æ‹“æ’²

```
+-----------------------------------------------------------------+
|                            INTERNET                             |
+-----------------------------------------------------------------+
        |                   |                        |
+----------------+ +------------------+ +-------------------------+
| Bell Fibe (3G) | | Starlink (Bak 1) | | Nighthawk M5 5G (Bak 2) |
+----------------+ +------------------+ +-------------------------+
        |                   |                        |
       10G                2.5G                      1G
        |                   |                        |
+-----------------------------------------------------------------+
|                  Dream Machine Special Edition                  |
+-----------------------------------------------------------------+
                                |
                             10G SFP+
                                |
+-----------------------------------------------------------------+
|                       USW-Pro-Aggregation                       |
+-----------------------------------------------------------------+
                                |
                    50G LACP (25G SFP28 * 2)
                                |
+-----------------------------------------------------------------+
|                       USW-EnterpriseXG-24                       |
+-----------------------------------------------------------------+
```

## å­˜å„²è¦åŠƒ

åœ¨ç¶²çµ¡å®‰æ’å¥½ä¹‹å¾Œï¼Œæˆ‘å»ºè­°å…ˆè€ƒæ…®å­˜å„²ï¼Œå­˜å„²æ±ºå®šäº†é€™å¥—è¨­å‚™èƒ½è™•ç†çš„æ•¸æ“šçš„æ¥µé™ï¼Œé€™å¯èƒ½åŒ…æ‹¬ä½ å·¥ä½œéœ€è¦å­˜å„²çš„æ•¸æ“šï¼Œä¾‹å¦‚è¦–é »å·¥ä½œè€…ï¼ŒAI å·¥ç¨‹å¸«ç­‰ç­‰å¾€å¾€éƒ½å°å­˜å„²ç©ºé–“æœ‰è¼ƒé«˜çš„éœ€æ±‚ã€‚å°æ–¼ homelab ä¾†èªªï¼Œå¯èƒ½é‚„æœ‰åª’é«”æœå‹™ï¼ŒéŠæˆ²ä¸²æµæœå‹™ï¼Œç›¸å†Šæœå‹™ç­‰ç­‰ä¸€äº›å€‹äººæ•¸æ“šçš„å­˜æ”¾ã€‚

å¦ç™½èªªï¼Œåœ¨æœ‰æ¢ä»¶çš„æƒ…æ³ä¸‹ï¼Œç›¡å¯èƒ½å¤šå®‰æ’å­˜å„²ï¼Œæœƒå°‘èµ°å¾ˆå¤šå½è·¯ã€‚å­˜å„²æ± æˆ‘å€‹äººå»ºè­°è‡³å°‘å®‰æ’ä¸€å€‹ SSD é«˜é€Ÿæ± ç”¨ä¾†æ”¯æŒè™›æ“¬åŒ–ã€æ•¸æ“šåº«ã€AI é‹ç®—ç­‰ï¼ŒåŠ ä¸€å€‹ HDD å¤§å®¹é‡å­˜å„²æ± ï¼Œç”¨ä¾†å­˜å„²å‚™ä»½æ•¸æ“šï¼Œéæ´»èºé …ç›®çš„å¤§é«”ç©æ•¸æ“šç­‰ã€‚æˆ‘å€‹äººæ¨è–¦å­˜å„²æ–¹æ¡ˆçš„é¸æ“‡æ‡‰è©²æ»¿è¶³å…©å€‹æ¢ä»¶ï¼šç©©å®šæ˜¯å¤§å‰æï¼Œéˆæ´»å¯ä¼¸ç¸®ç›¸ç•¶é‡è¦ï¼Œæˆ‘æœ€çµ‚çš„æ–¹æ¡ˆæ˜¯ï¼š

- é«˜é€Ÿå­˜å„²æ± é€šé Ceph å¯¦ç¾ï¼ŒSSD + NVMEï¼Œå–®ç›¤ 4TB * 5 ç›¤ * 4 ç¯€é»ï¼›
- å¤§å®¹é‡å­˜å„²æ± é€šé [Mdadm](https://docs.kernel.org/admin-guide/md.html) RAID6 å¯¦ç¾ï¼ŒHDDï¼Œå–®ç›¤ 18T * 12 ç›¤ï¼›

å…¶ä¸­çš„ Ceph æ˜¯è¶…èåˆé‡è¦çš„ä¸€ç’°ï¼Œå¾Œé¢æœƒè©³ç´°è§£é‡‹ã€‚è‡³æ–¼å¤§å®¹é‡çš„å­˜å„²æ± ç‚ºä»€éº¼é¸æ“‡ Mdadm è€Œä¸æ˜¯ [ZFS](https://openzfs.github.io/openzfs-docs/Getting%20Started/index.html) æˆ–è€… [LVM](https://en.wikipedia.org/wiki/Logical_Volume_Manager_(Linux))ï¼Œé€™å€‹ä¸»è¦çœ‹å€‹äººçš„å–œå¥½ã€‚æˆ‘å°ç©©å®šæ€§å’Œéˆæ´»æ€§éƒ½æœ‰å¾ˆé«˜çš„è¦æ±‚ï¼ŒZFS çš„ç¢ºå¾ˆå¼·å¤§ï¼Œä½†æ˜¯å°æ–¼é™£åˆ—çš„ä¼¸ç¸®æ€§æ¯”è¼ƒä¾·é™ï¼Œä¸èƒ½æ»¿è¶³æˆ‘å–œæ­¡æŠ˜é¨°çš„å–œå¥½ã€‚LVM å°å¿«ç…§çš„æ”¯æŒæ¯”è¼ƒå·®ï¼Œè€Œä¸”é‚„æœ‰ä¸å°‘å…¶ä»–å•é¡Œå°šæœªè§£æ±ºï¼Œä¾‹å¦‚å…§å»º RAID çš„å¯æ¢å¾©æ€§ç­‰ç­‰ã€‚æ‰€ä»¥æˆ‘é‚„æ˜¯é¸æ“‡äº†åœ¨ Linux ä¸Šå»£æ³›ä½¿ç”¨ï¼Œç©©å®šæ€§åŒæ¨£ç„¡å¯æŒ‘å‰”çš„ Mdadmï¼Œä¸¦åœ¨ä¸Šé¢ä½¿ç”¨ [Btrfs](https://docs.kernel.org/filesystems/btrfs.html) æ–‡ä»¶ç³»çµ±ä¾†æ”¯æŒå¿«ç…§å’Œæ–‡ä»¶æ ¡é©—ï¼Œæœ‰æ„æ€çš„æ˜¯ï¼Œé€™å€‹çµ„åˆæ°å¥½æ˜¯ Unifi UNAS Pro æ‰€ä½¿ç”¨çš„æ–¹å¼ã€‚ç•¶ç„¶ï¼Œé€™å€‹ä¸»è¦çœ‹å€‹äººå–œå¥½ï¼Œå°æ“´å±•æ€§ï¼Œéˆæ´»æ€§ï¼Œç©©å®šæ€§ï¼Œå®¹ç½é‡å»ºç­‰æ¯å€‹äººçš„ç†è§£éƒ½ä¸ä¸€æ¨£ï¼Œé¸æ“‡è‡ªå·±å–œæ­¡çš„ï¼Œä¸è¦é™·å…¥ç¥ä»™æ‰“æ¶çš„å±€é¢ã€‚

### Ceph

é‡é»ä»‹ç´¹ä¸€ä¸‹ [Ceph](https://ceph.io)ï¼Œé€™æ˜¯é–‹æºè¶…èåˆæ–¹æ¡ˆçš„æ ¸å¿ƒçµ„ä»¶ï¼Œå¦‚æœä½ æ­é… PVE ä½¿ç”¨çš„è©±ï¼Œé¸æ“‡ Ceph ä½œç‚ºå­˜å„²æ± ï¼Œå¯ä»¥ç²å¾—éå¸¸å¥½çš„æ€§èƒ½ï¼Œæ“´å±•æ€§å’Œç©©å®šæ€§ï¼ŒåŒæ™‚ PVE é¢æ¿ä¸Šæ•´åˆçš„ Ceph ç®¡ç†å·¥å…·ç°¡å–®å¯¦ç”¨ï¼Œå¯ä»¥å¿«é€Ÿç®¡ç†å­˜å„²é›†ç¾¤çš„å¥åº·ç‹€æ…‹ã€‚ç•¶ç„¶ PVE å° Ceph çš„é›†æˆé›–ç„¶å¾ˆå¥½ï¼Œä½†æ˜¯ Ceph æ˜¯ä¸€å¥—ååˆ†å¼·å¤§å’Œè¤‡é›œçš„åˆ†ä½ˆå¼å­˜å„²ç³»çµ±ï¼Œå¾ˆå¤šé«˜ç´šæ“ä½œä¾ç„¶éœ€è¦å‘½ä»¤è¡Œï¼Œé€™å€‹ç„¡å¯é¿å…ï¼Œå¾Œé¢æˆ‘æœƒä»‹ç´¹ä¸€äº›æ¯”è¼ƒå¸¸ç”¨çš„å‘½ä»¤ã€‚

ç‚ºä»€éº¼èªª Ceph æ˜¯è¶…èåˆæ–¹æ¡ˆçš„æ ¸å¿ƒï¼Ÿå…¶å¯¦å‰æ–‡å·²ç¶“æåˆ°ï¼Œåœ¨è¶…èåˆæ•¸æ“šä¸­å¿ƒè£¡é¢ï¼Œæ‰€æœ‰çš„è³‡æºæ˜¯å……åˆ†å…±äº«å’Œç¶²çµ¡åŒ–çš„ã€‚ä½ å¯ä»¥ç†è§£ï¼Œæ¥­å‹™ä¸æ˜¯é‹è¡Œåœ¨å–®ä¸€æ©Ÿå™¨ï¼Œæˆ–è€…å–®ä¸€å€‹è™›æ“¬æ©Ÿè£¡ï¼Œç²—ç•¥åˆæŠ½è±¡åœ°ç†è§£ï¼Œæœå‹™æ˜¯è·‘åœ¨é›†ç¾¤ä¸Šã€‚æ•´å€‹é›†ç¾¤ä¸€èµ·ä¾†æ”¯æ’æ¯å€‹æ¥­å‹™ï¼Œæ©Ÿå™¨ä¹‹é–“ç·Šå¯†ç›¸é€£ï¼Œç›¸äº’å‚™æ´ã€‚åœ¨ PVE ä¸­æ­£ç¢ºé…ç½® Ceph ä½œç‚ºå­˜å„²å¾Œç«¯ä¹‹å¾Œï¼Œè™›æ“¬æ©Ÿæ˜¯å¯ä»¥åœ¨é›†ç¾¤è£¡é¢éš¨æ„é·ç§»çš„ï¼ŒVM å¯ä»¥ä¸é—œæ©Ÿå¾ä¸€å€‹ä¸»æ©Ÿç›´æ¥é·ç§»åˆ°å¦ä¸€å€‹ä¸»æ©Ÿä¸Šé‹è¡Œï¼Œå°å¤–ç”šè‡³æ˜¯ç„¡æ„ŸçŸ¥çš„ã€‚é€™å¸¶ä¾†äº†å¾ˆå¤šä¾¿åˆ©ï¼Œä¾‹å¦‚ä¸€å°æ©Ÿå™¨æ•…éšœæˆ–è€…éœ€è¦ç¶­è­·é‡å•Ÿï¼Œä½ å®Œå…¨ä¸ç”¨æ“”å¿ƒä¸Šé¢çš„æ¥­å‹™ï¼ŒPVE å¯ä»¥è‡ªå‹•æŠŠé‹è¡Œä¸­çš„ VM åœ¨ç·šé·ç§»åˆ°é›†ç¾¤ä¸­å…¶ä»–æ©Ÿå™¨ä¸Šé‹è¡Œã€‚é€™ç¨®ç„¡ç¸«é·ç§»ä¾è³´é›†ç¾¤æŠŠå­˜å„²è¦–ç‚ºä¸€å€‹æ•´é«”ï¼Œå¾ä¸åŒæ©Ÿå™¨éƒ½å¯ä»¥è¨ªå•åˆ°ä¸€æ¨£çš„æ•¸æ“šã€‚PVE ç•¶ç„¶ä¹Ÿæ”¯æŒé€šé SAN ç¶²çµ¡æˆ–è€… NFS ç­‰å‚³çµ±æ–¹æ¡ˆä¾†å¯¦ç¾çµ±ä¸€å­˜å„²ï¼Œä½†é¡¯ç„¶ Ceph æ˜¯æ›´é¢å‘æœªä¾†çš„é¸æ“‡ã€‚

æœ‰å¹¾é»éœ€è¦æ³¨æ„ï¼š

- ç‚ºäº†ç²å¾—è¶³å¤ ç†æƒ³çš„ IOPS æ€§èƒ½ï¼Œè‡³å°‘ä¸€å€‹å…¨ SSD/NVME å­˜å„²æ± æ˜¯å€¼å¾—å„ªå…ˆè€ƒæ…®çš„ï¼›
- ç‚ºäº†ç²å¾—è¶³å¤ çš„å†—ä½™ï¼Œæ¨è–¦å¾ 4 å€‹ç¯€é»èµ·æ­¥ï¼Œsize 4ï¼Œmin 2 æ‡‰è©²æ˜¯æœ€ä½å®‰å…¨ä¿éšœï¼Œé€™ç›¸ç•¶æ–¼é›†ç¾¤ä¸­æ¯ä»½æ•¸æ“šä¿å­˜åœ¨ 4 å€‹ç¯€é»ä¸Šï¼Œè‡³å°‘æ»¿è¶³ 2 å€‹ç¯€é»åœ¨ç·šæ™‚å…è¨±è®€å¯«ï¼Œ2 å€‹ç¯€é»é›¢ç·šä¸å½±éŸ¿æ¥­å‹™ã€‚

## å®‰è£è™›æ“¬åŒ–å¹³å° PVE

Proxmax VE åŸºæ–¼ [Debian](https://www.debian.org)ï¼Œé€™å…¶å¯¦ä¹Ÿæ˜¯æˆ‘é¸æ“‡å®ƒçš„åŸå› ä¹‹ä¸€ã€‚ä½œç‚ºå¤šå¹´ Debian ç”¨æˆ¶ï¼Œæˆ‘å°æ–¼å®ƒçš„ç©©å®šæ€§ç›¸ç•¶æœ‰ä¿¡å¿ƒã€‚å®ƒå”¯ä¸€ç¼ºé»æ˜¯ä¿å®ˆï¼Œstable åˆ†æ”¯è»Ÿä»¶åŒ…ç›¸å°è¼ƒèˆŠï¼Œéœ€è¦å˜—æ–°å¯ä»¥ç”¨å…¶ä»–åˆ†æ”¯ï¼Œä½†æ˜¯æˆ‘èªç‚ºå®¿ä¸»æ©Ÿçš„ç©©å®šæ€§æ˜¯æœ€é‡è¦çš„ï¼Œå˜—æ–°å®Œå…¨å¯ä»¥åœ¨ VM ä¸­æŠ˜é¨°ã€‚

![PVE](./assets/Screenshot%202025-02-17%20at%2012.40.31â€¯AM.png)

äº‹å¯¦ä¸Šæˆ‘æ¨è–¦çš„å®‰è£æ–¹å¼ä¸¦ä¸æ˜¯ç›´å®‰è£ PVEï¼Œè€Œæ˜¯å…ˆå®‰è£ Debianï¼Œç„¶å¾Œå®‰è£ PVE è»Ÿä»¶åŒ…ã€‚é€™å€‹ä¸»è¦çš„åŸå› åœ¨æ–¼ï¼Œæˆ‘åœ¨å¹¾å€‹æœå‹™å™¨ä¸Šï¼Œå˜—è©¦ç›´æ¥å®‰è£ PVE éƒ½å¤±æ•—ï¼Œå¯èƒ½æ˜¯æˆ‘ç’°å¢ƒçš„å•é¡Œï¼Œä¹Ÿæœ‰å…¶ä»–æœ‹å‹å’Œæˆ‘é‡åˆ°ç›¸ä¼¼çš„å•é¡Œï¼Œé€™è£¡ä¸æ·±ç©¶ï¼Œä½†æ˜¯å¾ Debian ä¸Šå®‰è£ï¼Œè¡¨ç¾æ›´ç¬¦åˆé æœŸï¼š

- [ä½¿ç”¨å¼•å°ä»‹è³ªç›´æ¥å®‰è£ PVE](https://www.proxmox.com/en/products/proxmox-virtual-environment/get-started);
- [å¾ Debian å®‰è£ PVE](https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_12_Bookworm)

PVE å®˜æ–¹æ–‡æª”è¦æ±‚ Debian ç‰ˆæœ¬ç‚º 12(Bookworm)ï¼Œäº‹å¯¦ä¸Šå¤§å®¶å¯ä»¥æ”¾å¿ƒç›´æ¥åœ¨ stable åˆ†æ”¯ä¸Šé‹è¡Œã€‚æœ‰ä¸€äº›åŒ…æ¯” PVE é è¨­çš„æ›´æ–°ï¼Œä½†æ˜¯æ²’æœ‰ä»»ä½•å…¼å®¹æ€§å•é¡Œã€‚

### ç°¡è¿°å®‰è£æ­¥é©Ÿ

##### 1. å®‰è£ Debian 12 Bookwormï¼Œåˆ‡æ›åˆ° stable åˆ†æ”¯

##### 2. åœ¨ `/etc/host` ä¸­åŠ å…¥ç•¶å‰ä¸»æ©Ÿçš„ IP åœ°å€

```bash
# vim /etc/host
```

```hosts
[æœ¬æ©Ÿæœ¬åœ° IP]    [ç•¶å‰ä¸»æ©Ÿå]
```

Example:

```hosts
192.168.1.64    Enlightenment
```

ç¢ºä¿åœ°å€æ­£ç¢º

```bash
$ hostname --ip-address
```

ç¢ºä¿è¿”å›çš„åœ°å€æ˜¯ `/etc/host` ä¸­é…ç½®çš„åœ°å€ï¼Œè€Œä¸æ˜¯ `127.0.0.1` æˆ– `::1` ç­‰ `loopback` åœ°å€ã€‚

##### 3. æ·»åŠ  PVE çš„ apt æº

```bash
# echo "deb [arch=amd64] http://download.proxmox.com/debian/pve bookworm pve-no-subscription" > /etc/apt/sources.list.d/pve-install-repo.list
```

##### 4. æ·»åŠ  PVE æºçš„å¯†é‘°

```bash
# wget https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
```

é©—è­‰å¯†é‘°ï¼ˆæœ€æ–°å¯†é‘° hash å€¼è«‹åƒè€ƒ[å®˜æ–¹æ–‡æª”](https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_12_Bookworm)ï¼‰ï¼š

```bash
$ sha512sum /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
7da6fe34168adc6e479327ba517796d4702fa2f8b4f0a9833f5ea6e6b48f6507a6da403a274fe201595edc86a84463d50383d07f64bdde2e3658108db7d6dc87 /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
```

##### 5. æ›´æ–° apt æºï¼Œå‡ç´šç³»çµ±

```bash
# apt update && apt upgrade -y
```

##### 6. å®‰è£ PVE å…§æ ¸

```bash
# apt install proxmox-default-kernel
# systemctl reboot
```

##### 7. å®‰è£ PVE å¥—ä»¶

```bash
# apt install proxmox-ve postfix open-iscsi chrony
```

##### 8. åˆªé™¤ Debian é»˜èªå…§æ ¸

```bash
# apt remove linux-image-amd64 'linux-image-6.1*'
# update-grub
```

##### 9. åˆªé™¤ os-prober

é¿å…è™›æ“¬æ©Ÿè¢«éŒ¯èª¤åŠ åˆ°å¼•å°èœå–®ã€‚

```bash
# apt remove os-prober
```

##### 10. åˆªé™¤ä¼æ¥­ç‰ˆ apt æºï¼Œåƒ…ä½¿ç”¨é–‹æºç‰ˆçµ„ä»¶

å¦‚æœä½ æ‰“ç®—è³¼è²·ä¼æ¥­ç‰ˆï¼Œå¿½ç•¥æ­¤æ­¥é©Ÿã€‚

```bash
# rm /etc/apt/sources.list.d/pve-install-repo.list
```

##### 11. é‡å•Ÿï¼Œç¢ºä¿å¯ä»¥æ­£å¸¸å¼•å°

å¦‚æœä½ çš„ Debian æ˜¯å•Ÿå‹•åˆ°å‘½ä»¤è¡Œçš„ï¼Œä½ æ‡‰è©²æœƒçœ‹åˆ° PVE çš„æ­¡è¿ä»‹é¢ï¼Œå¦‚æœä½ æ˜¯å•Ÿå‹•åˆ°åœ–å½¢ä»‹é¢çš„ï¼Œä½ ä¸æœƒçœ‹åˆ°ä»»ä½•è®ŠåŒ–ï¼Œå¯ä»¥åŸ·è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ PVE æ˜¯ä¸æ˜¯å·²ç¶“æ­£ç¢ºå®‰è£ï¼š

```bash
$ pveversion
```

å¦‚æœçœ‹åˆ°é¡ä¼¼ä»¥ä¸‹çš„è¼¸å‡ºï¼Œèªªæ˜ PVE å·²ç¶“æ­£ç¢ºå®‰è£ï¼š

```
pve-manager/8.3.3/f157a38b211595d6 (running kernel: 6.11.0-1-pve)
```

æ³¨æ„ï¼Œå¦‚æœç„¡æ³•çœ‹åˆ° PVE æ­¡è¿ä»‹é¢ï¼Œå…ˆæª¢æŸ¥ä¸€ä¸‹ä¸Šé¢ IP åœ°å€çš„æ­¥é©Ÿã€‚

##### 12. è¨ªå• PVE ç®¡ç†é¢æ¿

PVE ç®¡ç†é é¢é»˜èªå¯ä»¥é€šéé€™å€‹åœ°å€è¨ªå•ï¼š

```
https://[ç¯€é»æœ¬åœ° IP åœ°å€]:8006
```

ä¾‹å¦‚ï¼š

```
https://192.168.1.64:8006
```

æ³¨æ„å”è­°æ˜¯`https`ï¼Œç€è¦½å™¨éœ€è¦å¿½ç•¥ä¸€ä¸‹è‡ªç°½è­‰æ›¸çš„å®‰å…¨æª¢æŸ¥ã€‚ç®¡ç†é é¢é»˜èªå¯ä»¥é€šéç³»çµ±çš„`root`å¸³æˆ¶å¯†ç¢¼ç™»é™¸ï¼Œ`Realm`é¸æ“‡`Linux PAM standard authentication`ï¼Œé€²å…¥ç³»çµ±ä¹‹å¾Œé…ç½®å…¶ä»–ç™»éŒ„é©—è­‰æ–¹å¼ã€‚

è‡³æ­¤ PVE ç¯€é»å·²ç¶“å®Œæˆäº†åŸºæœ¬çš„å®‰è£ï¼Œä¸‹é¢æˆ‘æœƒé–‹å§‹ä»‹ç´¹ä¸€äº›å¿…é ˆçš„é…ç½®é …ç›®ã€‚

### é…ç½®ç¶²çµ¡

ä½ éœ€è¦å…ˆé…ç½®ä¸€å€‹ç¶²æ©‹ï¼Œä¾¿æ–¼ VM è¨ªå•ç¶²çµ¡ï¼Œ[PVE å®˜æ–¹æ–‡æª”ä¸­æœ‰è©³æƒ…](https://pve.proxmox.com/wiki/Network_Configuration)ï¼š

#### 1. å…ˆæŸ¥è©¢ç¶²å¡è¨­å‚™è™Ÿ

```bash
$ ifconfig -a
```

è­˜åˆ¥å‡ºç¶²å£è¨­å‚™è™Ÿï¼Œå¦‚ eno1, enp1s0 ç­‰ç­‰ï¼Œç´€éŒ„ä¸‹ä¾†ã€‚

#### 2. é…ç½®ç¶²æ©‹

ç·¨è¼¯ `/etc/network/interfaces` æ–‡ä»¶ï¼Œæ ¹æ“šéœ€è¦æ·»åŠ ä»¥ä¸‹å…§å®¹ï¼š

```interfaces
auto lo
iface lo inet loopback

auto [ç¶²å£è¨­å‚™è™Ÿ]
iface [ç¶²å£è¨­å‚™è™Ÿ] manual

auto [æ–°å»ºç¶²æ©‹è¨­å‚™è™Ÿï¼Œå¦‚ vmbr0]
iface [æ–°å»ºç¶²æ©‹è¨­å‚™è™Ÿï¼Œå¦‚ vmbr0] inet static
        address [é…ç½®ç‚ºå®‰è£æ­¥é©Ÿä¸­æŒ‡å®šçš„ IP åœ°å€]/24(å¯é€šé`/`é…ç½®ç¶²æ®µï¼Œä¹Ÿå¯é€šé`netmask`ä¾†é…ç½®)
        netmask [å­ç¶²æ©ç¢¼](å¦‚æœä¸Šé¢ä¸€è¡Œå·²é…ç½®ç¶²æ®µï¼Œæ­¤è™•å¯å¿½ç•¥)
        gateway [é…ç½®ç¶²é—œåœ°å€]
        bridge-ports [ç¶²å£è¨­å‚™è™Ÿï¼Œå¦‚å‰æ‰€è¿°]
        bridge-stp off
        bridge-fd 0
```

### 3. é…ç½®éˆè·¯èšåˆ

å¦‚äº¤æ›æ©Ÿæ”¯æŒ LACPï¼Œæˆ–æœ‰å…©å€‹ä»¥ä¸Šäº¤æ›æ©Ÿä¸”åŒæ™‚é€£æ¥ï¼Œå¼·çƒˆå»ºè­°é…ç½®[éˆè·¯èšåˆ](https://pve.proxmox.com/wiki/Network_Configuration)ï¼Œä½ å¯ä»¥èšåˆå…©å€‹æˆ–å¤šå€‹ç¶²çµ¡æ¥å£ï¼Œé€™æ¨£å¯ä»¥æé«˜ç¶²çµ¡çš„ç©©å®šæ€§å’Œå¸¶å¯¬ï¼Œå°é›†ç¾¤çš„ç©©å®šæ€§ï¼Œç‰¹åˆ¥æ˜¯ Ceph çš„ç©©å®šæ€§æœ‰å¾ˆå¤§çš„å¹«åŠ©ã€‚

ç·¨è¼¯ `/etc/network/interfaces` æ–‡ä»¶ï¼Œæ ¹æ“šéœ€è¦æ·»åŠ ä»¥ä¸‹å…§å®¹ï¼Œæ³¨æ„ç”±æ–¼å¢åŠ äº†éˆè·¯èšåˆå±¤ï¼Œç¶²æ©‹ä¸­æŒ‡å®šçš„è¨­å‚™è™Ÿè¦`ç‰©ç†ç¶²å£è¨­å‚™è™Ÿ`æ”¹ç‚º`èšåˆè¨­å‚™è™Ÿ`ï¼š

```interfaces
auto [ç¶²å£ 1 è¨­å‚™è™Ÿ]
iface [ç¶²å£ 1 è¨­å‚™è™Ÿ] manual

auto [ç¶²å£ 2 è¨­å‚™è™Ÿ]
iface [ç¶²å£ 2 è¨­å‚™è™Ÿ] manual

[...]

auto [æ–°å»ºéˆè·¯èšåˆè¨­å‚™è™Ÿï¼Œå¦‚ bond0]
iface [æ–°å»ºéˆè·¯èšåˆè¨­å‚™è™Ÿï¼Œå¦‚ bond0] inet manual
    bond-slaves [ç¶²å£ 1 è¨­å‚™è™Ÿ] [ç¶²å£ 2 è¨­å‚™è™Ÿ] [...]
    bond-mode 802.3ad
    bond-xmit-hash-policy encap3+4
    bond-miimon 100
    bond-downdelay 200
    bond-updelay 200
    bond-lacp-rate 1

auto [æ–°å»ºç¶²æ©‹è¨­å‚™è™Ÿï¼Œå¦‚ vmbr0]
iface [æ–°å»ºç¶²æ©‹è¨­å‚™è™Ÿï¼Œå¦‚ vmbr0] inet static
    address [é…ç½®ç‚ºå®‰è£æ­¥é©Ÿä¸­æŒ‡å®šçš„ IP åœ°å€]/24(å¯é€šé`/`é…ç½®ç¶²æ®µï¼Œä¹Ÿå¯é€šé`netmask`ä¾†é…ç½®)
    netmask [å­ç¶²æ©ç¢¼](å¦‚æœä¸Šé¢ä¸€è¡Œå·²é…ç½®ç¶²æ®µï¼Œæ­¤è™•å¯å¿½ç•¥)
    gateway [é…ç½®ç¶²é—œåœ°å€]
    bridge-ports [èšåˆè¨­å‚™è™Ÿï¼Œå¦‚ bond0ï¼Œéœ€å’Œä¸Šä¸€å°ç¯€ä¿æŒä¸€è‡´]
    bridge-stp off
    bridge-fd 0
```

#### 4. é‡å•Ÿç¶²çµ¡ä»¥æ‡‰ç”¨é…ç½®

```bash
# systemctl restart networking
```

#### 5. é–‹å•Ÿ [Jumbo Frame](https://en.wikipedia.org/wiki/Jumbo_frame)

Jumbo Frame æ˜¯ 10GE å°æ–¼é«˜é€Ÿç¶²çµ¡è‡³é—œé‡è¦ï¼Œæ›´å¤§çš„åŒ…å¯ä»¥æ¸›å°‘åŒ…çš„æ•¸é‡ï¼Œé™ä½ CPU åœ¨å°åŒ…å’Œè§£åŒ…éç¨‹çš„è² æ“”ï¼Œé¡¯è‘—æå‡ç¶²çµ¡çš„ååé‡ã€‚å°æ–¼ Ceph ä¾†èªªï¼ŒJumbo Frame è‡³é—œé‡è¦ã€‚

é…ç½®ä¸»è¦ç¶²çµ¡è¨­å‚™çš„ MTU ç‚º 9000ï¼Œæ ¹æ“šå‰é¢çš„é…ç½®å¡«å…¥åˆé©çš„`è¨­å‚™è™Ÿ`ï¼Œä¾‹å¦‚ `vmbr0`(ç„¡èšåˆ) æˆ– `bond0`(æœ‰èšåˆ)ï¼š

```bash
# /usr/bin/ip link set [è¨­å‚™è™Ÿ] mtu 9000
```

ä½ å¯æŠŠé¡ä¼¼çš„é…ç½®æ”¾åœ¨`/etc/network/interfaces`ä¸­ï¼Œä¹Ÿå¯ç›´æ¥æŠŠä¸Šé¢çš„å‘½ä»¤æ”¾åœ¨`/etc/crontab`ä¸­ï¼Œé€šé`@reboot`å’Œ`sleep`(ç­‰å¾…ç¶²çµ¡åˆå§‹åŒ–å®Œæˆ)ä¾†åŸ·è¡Œï¼Œå®Œå…¨æ˜¯å€‹äººå–œå¥½ï¼Œæ­¤è™•ä¸ä½œè´…è¿°ã€‚

æ³¨æ„ï¼è«‹ä¿è­‰æ¯å€‹ç¯€é»ä½¿ç”¨ç›¸åŒçš„ MTU å°åŒ…å°ºå¯¸ï¼Œé€™å°‡æ˜¯é›†ç¾¤ç©©å®šæ€§çš„é—œéµï¼Œå¦‚æœ MTU ä¸ä¸€è‡´ï¼ŒPVE é›†ç¾¤æœƒå‡ºç¾ä¸ç©©å®šï¼Œç¯€é»æ‰ç·šç­‰æƒ…æ³ã€‚å°æ–¼ Ceph å°¤å…¶å¦‚æ­¤ï¼Œä¸ä¸€è‡´çš„ MTU æœƒå°è‡´ OSD å¿ƒè·³å—é˜»ï¼Œé€²è€Œå°è‡´ OSD é »ç¹å¾é›†ç¾¤ä¸­é›¢ç·šã€‚æˆ‘æœ‰ä¸€å€‹ç¯€é»å‡ºç¾é€™å€‹æƒ…æ³èŠ±äº†å¾ˆé•·æ™‚é–“æ‰è§£æ±ºã€‚

#### 6. æ¸¬é€Ÿï¼Œç¢ºä¿é€Ÿåº¦ç¬¦åˆé æœŸ

ç‚ºäº†æ–¹ä¾¿èª¿è©¦ï¼Œæˆ‘å»ºè­°æ‰€æœ‰ç¯€é»é–‹å•Ÿ iperf3 æœå‹™ï¼Œé€™æ¨£å¯ä»¥å¤§å¤§æ–¹ä¾¿ç¯€é»é–“çš„çš„ç¶²çµ¡èª¿è©¦ã€‚

```bash
# apt install iperf3
```

å¾ A ç¯€é»æ¸¬è©¦åˆ° B ç¯€é»çš„ç¶²çµ¡é€Ÿåº¦ï¼š

```bash
# iperf3 -c [B ç¯€é» IP åœ°å€] -P [ç·šç¨‹æ•¸]
```

å…¶ä¸­`-P`åƒæ•¸å¯ä»¥æŒ‡å®šæ¸¬è©¦çš„ç·šç¨‹æ•¸ï¼Œé»˜èªæ˜¯ 1 å€‹ç·šç¨‹ã€‚å¦‚æœéœ€è¦æ¸¬è©¦å¤šå€‹ç·šç¨‹çš„è©±ï¼Œä¾‹å¦‚æ¸¬è©¦ LACP çš„æ•ˆæœï¼Œå¯ä»¥æŒ‡å®šå¤šå€‹ç·šç¨‹ï¼Œä¾‹å¦‚`-P 10`è¡¨ç¤ºä½¿ç”¨ 10 å€‹ç·šç¨‹é€²è¡Œæ¸¬è©¦ã€‚

### é…ç½®é¡¯å¡ç›´é€š

å¦‚æœ‰ AI é‹ç®—ã€éŠæˆ²æˆ–è¦–é »å‰ªè¼¯éœ€æ±‚ï¼Œé¡¯å¡ç›´é€šå¿…ä¸å¯å°‘ï¼Œé€™è£¡é¢ç¶²ä¸Šæœ‰å¾ˆå¤šçš„ä»‹ç´¹ï¼Œæœ‰å°æœ‰éŒ¯ï¼Œé€™è£¡ç°¡å–®ç¸½çµä¸€ä¸‹æ­¥é©Ÿï¼š

#### 1. ç¢ºä¿`BIOS`ä¸­é–‹å•Ÿ`IOMMU`

ç¢ºèª IOMMU å¯ç”¨å°¤å…¶é‡è¦ï¼Œæœ‰ä¸€äº›ä¸»æ¿æ˜¯é»˜èªé—œé–‰çš„ï¼Œä¹Ÿæœ‰ä¸€äº›ä¸»æ¿æ˜¯é»˜èªé–‹å•Ÿçš„ï¼Œéœ€è¦æ‰‹å‹•ç¢ºèªä¸€ä¸‹ï¼š

```bash
# dmesg | grep -e DMAR -e IOMMU
```

ç¢ºä¿è¼¸å‡ºä¸­æœ‰ï¼š

```
DMAR: IOMMU enabled
```

#### 2. ç¢ºä¿`IOMMU interrupt remapping`å¯ç”¨

```bash
# dmesg | grep 'remapping'
```

ç¢ºä¿è¼¸å‡ºä¸­æœ‰ï¼š

```
AMD-Vi: Interrupt remapping enabled

[OR]

DMAR-IR: Enabled IRQ remapping in ******* mode
```

å¦‚æ‰¾ä¸åˆ°ï¼Œå¯å˜—è©¦å¼·åˆ¶é–‹å•Ÿï¼š

```bash
# echo "options vfio_iommu_type1 allow_unsafe_interrupts=1" > /etc/modprobe.d/iommu_unsafe_interrupts.conf
```

#### 3. ç·¨è¼¯`/etc/modules`ç¢ºä¿æœ‰ä»¥ä¸‹çš„æ¢ç›®

```modules
vfio
vfio_iommu_type1
vfio_pci
vfio_virqfd
```

#### 4. å¦‚è¨ˆç•«è™›æ“¬`macOS`ï¼Œç¢ºä¿`ignore_msrs=1`è¢«æ­£ç¢ºé…ç½®

```bash
# echo "options kvm ignore_msrs=1" > /etc/modprobe.d/kvm.conf
```

#### 5. è®“å®¿ä¸»æ©Ÿå•Ÿå‹•çš„æ™‚ï¼Œå¿½ç•¥éƒ¨åˆ†é¡¯å¡é©…å‹•ï¼Œé ç•™è³‡æºçµ¦ VM

ä¸åŠ è¼‰ AMD é¡¯å¡çš„é©…å‹•ï¼š

```bash
# echo "blacklist amdgpu" >> /etc/modprobe.d/blacklist.conf
# echo "blacklist radeon" >> /etc/modprobe.d/blacklist.conf
```

ä¸åŠ è¼‰ NVIDIA é¡¯å¡çš„é©…å‹•ï¼š

```bash
# echo "blacklist nouveau" >> /etc/modprobe.d/blacklist.conf
# echo "blacklist nvidia*" >> /etc/modprobe.d/blacklist.conf
```

ä¸åŠ åœ¨ Intel é¡¯å¡çš„é©…å‹•ï¼š

```bash
# echo "blacklist i915" >> /etc/modprobe.d/blacklist.conf
```

#### 6. æ›´æ–°å•Ÿå‹•é¡åƒ

```bash
# update-initramfs -u
```

ğŸ”” å®Œæˆä»¥ä¸Šæ“ä½œå¾Œï¼Œå¤§éƒ¨åˆ† AMDã€NVIDIA å’Œ Intel é¡¯å¡éƒ½èƒ½ç›´é€šçµ¦ VM ä½¿ç”¨äº†ï¼Œéœ€è¦æ³¨æ„å¦‚å®¿ä¸»æ©Ÿéœ€è¦ GUIï¼Œä¸è¦å¿½ç•¥ Intel æ ¸é¡¯ï¼Œé€™æ¨£å¯ä»¥ä¿ç•™æ¿è¼‰é¡¯å¡ç”¨ä¾†äº®æ©Ÿå’Œèª¿è©¦ã€‚

å¦‚ç¶“æ­·ä¸Šé¢æ“ä½œå¾Œä¾ç„¶å‡ºç¾å•é¡Œï¼Œå€‹äººå»ºè­°æ›´æ›æ”¯æŒåº¦æ›´é«˜å’Œæ›´æ–°çš„é¡¯å¡ï¼Œé›–ç„¶ç¶²ä¸Šæœ‰å¾ˆå¤š workaround å¯ä¸€å®šç¨‹åº¦è§£æ±ºå•é¡Œï¼Œä½†ç©©å®šæ€§å’Œå…¼å®¹æ€§é›£ä»¥ä¿è­‰ï¼ŒåŒæ™‚éœ€è¦é¡å¤–çš„ hack ä¾†è§£æ±ºçš„é¡¯å¡ä¸€èˆ¬éƒ½è¼ƒè€ï¼Œç®—åŠ›ä¸Šæ„ç¾©ä¸å¤§ï¼Œå¯è¶æ©Ÿå‡ç´šã€‚æ›´å¤šä¿¡æ¯å¯ä»¥åƒè€ƒ[å®˜æ–¹æ–‡æª”](https://pve.proxmox.com/wiki/PCI_Passthrough)ã€‚

## çµ„å»º PVE é›†ç¾¤

æ¯ä¸€å€‹ PVE ç¯€é»éƒ½è¦ç¶“æ­·ä¸Šé¢çš„å®‰è£å’Œé…ç½®ï¼Œåœ¨æ‰€æœ‰ç¯€é»éƒ½å®Œæˆé…ç½®å¾Œï¼Œå°±å¯ä»¥é–‹å§‹æŠŠ PVE ç¯€é»çµ„åˆæˆé›†ç¾¤ã€‚ç‚ºäº†ç©©å®šå¯ç”¨ï¼ŒPVE é›†ç¾¤å’Œ Ceph é›†ç¾¤éƒ½éœ€è¦æœ€å°‘ 3 å€‹ç¯€é»ã€‚å€‹äººæ¨è–¦æœ€å°‘ 4 å€‹ç¯€é»èµ·æ­¥ã€‚å…©å€‹ç¯€é»ï¼Œç•¶å…¶ä¸­ä¸€å€‹ç¯€é» down æ‰ä¹‹å¾Œï¼ŒæŠ•ç¥¨ç„¡æ³•éåŠæ•¸ï¼Œéœ€è¦æ‰‹å‹•ä¿®æ”¹æŠ•ç¥¨è¦å‰‡æ‰èƒ½å•Ÿå‹•è™›æ“¬æ©Ÿæˆ–è€…è®Šæ›´é›†ç¾¤ã€‚

åœ¨çµ„å»ºé›†ç¾¤ä¹‹å‰ï¼Œå…ˆé¸å‡ºä¸€å€‹ç¯€é»ä½œç‚º`ä¸»ç¯€é»`ï¼Œé€™è£¡æš«ä¸”ç¨±å…¶ç‚º`ä¸»ç¯€é»`ï¼Œä½†æ˜¯å…¶å¯¦ PVE ä¸¦æ²’æœ‰`ä¸»å¾ç¯€é»`æ¦‚å¿µï¼Œé›†ç¾¤æ˜¯é€šé`quorum`æŠ•ç¥¨ä¾†å–å¾—ä¸€è‡´æ€§çš„ã€‚ç¢ºå®šä¸€å€‹æ‰€è¬‚çš„`ä¸»ç¯€é»`æ˜¯å› ç‚º`è¢«åŠ å…¥`é›†ç¾¤çš„`å¾ç¯€é»`ä¸èƒ½æ“æœ‰ VMï¼Œæ›´åº•å±¤çš„åŸå› æ˜¯ VM id çš„å…¨å±€å”¯ä¸€æ€§ç´„æŸã€‚æ‰€ä»¥å·²ç¶“æœ‰ VM çš„æ©Ÿå™¨æ˜¯ä¸å…è¨±ç›´æ¥åŠ å…¥é›†ç¾¤çš„ï¼Œéœ€è¦å…ˆå‚™ä»½ä¸¦éŠ·æ¯€ VMï¼Œå¾…é€²å…¥é›†ç¾¤å¾Œæ¢å¾©ã€‚

åœ¨`ä¸»ç¯€é»`ä¸Šå‰µå»ºé›†ç¾¤ï¼Œé€šé`CLUSTER_NAME`æŒ‡å®šé›†ç¾¤åç¨±ï¼š

```bash
# pvecm create [CLUSTER_NAME]
```

åœ¨`å¾ç¯€é»`ä¸ŠåŠ å…¥é›†ç¾¤ï¼Œ`CLUSTER-IP-ADDRESS`å¯ä»¥æ˜¯é›†ç¾¤ä¸­ä»»æ„ä¸€å€‹ç¯€é»çš„ IP åœ°å€ï¼š

```bash
# pvecm add [CLUSTER-IP-ADDRESS]
```

æŸ¥çœ‹é›†ç¾¤çš„ç‹€æ…‹ï¼š

```bash
# sudo pvecm status
```

è¼¸å‡ºé¡ä¼¼ï¼š

```
Cluster information
-------------------
Name:             Dream
Config Version:   8
Transport:        knet
Secure auth:      on

Quorum information
------------------
Date:             Sun Feb 16 03:32:55 2025
Quorum provider:  corosync_votequorum
Nodes:            4
Node ID:          0x00000001
Ring ID:          1.b1f
Quorate:          Yes

Votequorum information
----------------------
Expected votes:   4
Highest expected: 4
Total votes:      4
Quorum:           3
Flags:            Quorate

Membership information
----------------------
    Nodeid      Votes Name
0x00000001          1 192.168.1.204 (local)
0x00000002          1 192.168.1.201
0x00000003          1 192.168.1.202
0x00000004          1 192.168.1.79
```

æŸ¥çœ‹é›†ç¾¤ç¯€é»å’ŒæŠ•ç¥¨æ¬Šé‡ï¼š

```bash
# sudo pvecm nodes
```

è¼¸å‡ºé¡ä¼¼ï¼š

```
Membership information
----------------------
    Nodeid      Votes Name
         1          1 Enlightenment (local)
         2          1 Juan
         3          1 Rio
         4          1 Rubao
```

ä¸Šé¢å…©å€‹å‘½ä»¤æœ‰æ­£å¸¸çš„è¿”å›ï¼Œèªªæ˜é›†ç¾¤å·²ç¶“çµ„å»ºæˆåŠŸã€‚

é †å£èªªä¸€ä¸‹ï¼Œå¦‚æœéœ€è¦ç§»é™¤ä¸€å€‹ç¯€é»çš„è©±ï¼Œå¯ä»¥ç”¨é€™å€‹å‘½ä»¤ï¼š

```bash
# pvecm delnode [NODE-NAME]
```

## Ceph é…ç½®

![Ceph](./assets/Screenshot%202025-02-18%20at%201.41.13â€¯AM.png)

ä¸€å¥è©±æ¦‚æ‹¬ Ceph æ˜¯ä»€éº¼ï¼šä¸€ç¨®åˆ†ä½ˆå¼çš„ç¶²çµ¡å­˜å„²ï¼Œaka è·¨ç¯€é»çš„é«˜æ€§èƒ½é«˜å¯ç”¨çš„ç£ç›¤é™£åˆ—ã€‚ä¸‹é¢ä»‹ç´¹ä¸€ä¸‹ Ceph çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼š

- Ceph é›†ç¾¤ç”± Monitorï¼ŒOSDï¼ŒMDSï¼ŒMGR ç­‰æœå‹™è§’è‰²çµ„æˆï¼›
- Ceph é€šéå¹¾ç¨®å¸¸è¦‹çš„æ–¹å¼ä¾†æä¾›å­˜å„²ï¼š
    - RBD (Ceph Block Device)ï¼šå¡Šè¨­å‚™ï¼Œæä¾›å¡Šç´šåˆ¥çš„å­˜å„²ï¼Œå¯ä»¥ä½œç‚ºè™›æ“¬æ©Ÿçš„ç£ç›¤ä½¿ç”¨ï¼›
    - RGW (Ceph Object Gateway)ï¼šå°è±¡å­˜å„²ï¼Œæä¾›å°è±¡ç´šåˆ¥çš„å­˜å„²ï¼Œå¯ä»¥ä½œç‚ºå°è±¡å­˜å„²ä½¿ç”¨ï¼Œå¯ç›´æ¥å°å‡ºç‚º S3 å…¼å®¹çš„å°è±¡å­˜å„²ï¼ŒNFS å…¼å®¹çš„æ–‡ä»¶ç³»çµ±ç­‰ï¼›
    - CephFS (Ceph File System)ï¼šPOSIX å…¼å®¹çš„æ–‡ä»¶ç³»çµ±ï¼Œå¯ä»¥ä½œç‚ºæ–‡ä»¶ç³»çµ±ä½¿ç”¨ã€‚
- MON (Monitor) è² è²¬é›†ç¾¤çš„å…ƒæ•¸æ“šç®¡ç†ï¼ŒåŒ…æ‹¬é›†ç¾¤çš„æ‹“æ’²çµæ§‹ï¼Œç¯€é»çš„å¥åº·ç‹€æ…‹ç­‰ï¼›
- MGR (Manager) è² è²¬é›†ç¾¤çš„ç›£æ§å’Œå‘Šè­¦ï¼Œå¯ä»¥é€šé Web ç•Œé¢ã€API æŸ¥çœ‹é›†ç¾¤çš„ç‹€æ…‹ï¼Œå®ƒé‚„è² è²¬æ”¯æŒ Ceph cli æŒ‡ä»¤ï¼Œæä¾› iSCSI Gateway å’Œ NFS Gateway ç­‰å¤–éƒ¨è¨ªå•æœå‹™ï¼›
- OSD (Object Storage Daemon) è² è²¬æ•¸æ“šçš„å­˜å„²å’Œæª¢ç´¢ï¼Œæ¯å€‹ç¯€é»çš„æ¯å¡Šç‰©ç†å­˜å„²ï¼Œéƒ½éœ€è¦é…ç½®ä¸€å€‹ OSD é€²ç¨‹ï¼Œä»–å€‘å„è‡ªç¨ç«‹ï¼Œäº’ä¸å¹²æ“¾ï¼Œåªå° Monitor è² è²¬ï¼›
- MDS (Metadata Server) è² è²¬æ–‡ä»¶ç³»çµ±çš„å…ƒæ•¸æ“šç®¡ç†ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ CephFS çš„è©±ï¼Œå°±éœ€è¦é…ç½® MDSï¼ŒCephFS æœå‹™ overhead è¼ƒå¤§ï¼Œæ ¹æ“šéœ€è¦é–‹å•Ÿï¼Œä½†ä½œç‚ºè·¨ç¯€é»æ–‡ä»¶å…±äº«æœå‹™ç›¸ç•¶å¥½ç”¨ï¼Œæ¨è–¦å¤§å®¶å˜—è©¦ï¼›
- PG (Placement Group) æ˜¯ Ceph æ•¸æ“šçš„é‚è¼¯ç®¡ç†å–®å…ƒï¼ŒCeph é€šé PG ä¾†ç®¡ç†æ•¸æ“šåˆ†ä½ˆï¼Œæ¯å€‹ OSD é€šå¸¸æœƒåŒ…å«è‹¥å¹²å€‹ PGï¼Œæ¯å€‹ PG æœƒæ ¹æ“š CRUSH map ç­–ç•¥åœ¨ä¸åŒ OSD ä¸Šæ”¾ç½®å‰¯æœ¬ï¼Œå¾Œé¢æœƒä»‹ç´¹ PG çš„é…ç½®ç­–ç•¥ã€‚
- ä»¥ä¸Šæåˆ°çš„è§’è‰²åœ¨ homelab å‰æä¸‹ï¼Œéƒ½å¯ä»¥æ”¾å¿ƒè·‘åœ¨åŒä¸€æ©Ÿå™¨ä¸Šï¼Œé›–ç„¶ç†æƒ³ç’°å¢ƒæ˜¯æ‡‰è©²åˆ†é–‹ï¼Œä½†æ˜¯ homelab ç’°å¢ƒä¸‹é€™å€‹å¦¥å”ä¸æœƒå¸¶ä¾†éå¤š drawbackã€‚

Ceph æ˜¯å‰¯æœ¬å†—ä½™ï¼Œå®ƒå’Œ RAID æœ‰ä¸€é»åƒï¼Œä½†æ˜¯ä¸¦ä¸å®Œå…¨ä¸€æ¨£ï¼Œæ›´æ¥è¿‘ Btrfs çš„å†—é¤˜è¨­è¨ˆï¼Œå­˜å„²æ± çš„é€™å…©å€‹åƒæ•¸è‡³é—œé‡è¦ï¼š

- Sizeï¼ˆå‰¯æœ¬æ•¸ï¼‰ï¼šå‰¯æœ¬æ•¸è¡¨ç¤ºæ•¸æ“šçš„å†—é¤˜åº¦ï¼Œé»˜èªæ˜¯ 3ï¼Œè¡¨ç¤ºæ•¸æ“šå¯«å…¥ 3 ä»½ï¼Œåˆ†ä½ˆåœ¨ä¸åŒç¯€é»ï¼ˆé»˜èªï¼‰ã€OSDã€æ©Ÿæ«ƒã€å­˜å„²çµ„æˆ–æ•¸æ“šä¸­å¿ƒå…§ï¼Œä½ æœ‰å¤šå°‘å¯å¯«è¨­å‚™éƒ½æ²’é—œä¿‚ï¼Œæœ‰ 5 å€‹ç¯€é»ï¼Œå¦‚å‰¯æœ¬æ•¸æ˜¯ 3ï¼Œé‚£éº¼å®ƒä¾ç„¶åªæŠŠæ•¸æ“šæ”¾åˆ° 3 å€‹ç¯€é»ä¸Šï¼›
- Min Sizeï¼ˆæœ€å°å‰¯æœ¬æ•¸ï¼‰ï¼šæœ€å°å‰¯æœ¬æ•¸è¡¨ç¤ºæ•¸æ“šçš„æœ€å°å¯ç”¨å†—é¤˜åº¦ï¼Œé»˜èªæ˜¯ 2ï¼Œè¡¨ç¤ºæ•¸æ“šè‡³å°‘éœ€è¦ 2 ä»½å‰¯æœ¬é€™ä»½æ•¸æ“šæ‰å¯ä»¥è¢«è®€å¯«ã€‚

### å®‰è£ Ceph æ‰€éœ€è¦çš„è»Ÿä»¶åŒ…

Ceph é…ç½®å¾ˆç°¡å–®ï¼Œç›´æ¥åœ¨ PVE Web ç•Œé¢ä¸­å®‰è£å³å¯ã€‚å®ƒæœƒè‡ªå‹•å®‰è£ Ceph ä¸¦é…ç½®æˆé›†ç¾¤ï¼Œä¸€èˆ¬ç„¡éœ€è‡ªå·±æ“å¿ƒã€‚åƒè€ƒ[é€™å€‹è¦–é »](https://www.proxmox.com/en/services/training-courses/videos/proxmox-virtual-environment/install-ceph-server-on-proxmox-ve)çš„å‰ 9 åˆ†é˜ï¼Œå¯ä»¥è¼•é¬†å®Œæˆã€‚

### Ceph é«˜å¯ç”¨çš„å‰ææ¢ä»¶

- ç©©å®šå¿«é€Ÿçš„ç¶²çµ¡æ˜¯ Ceph çš„åŸºç¤ï¼Œå¦‚ç¶²çµ¡å—é™ Ceph ç©©å®šæ€§å’Œæ€§èƒ½éƒ½æœƒå—åˆ°å¾ˆå¤§å½±éŸ¿ï¼Œé€™å°±æ˜¯ç‚ºä»€éº¼å»ºè­° 10GE èµ·æ­¥ï¼›
- éå¾—å»çš„ CPUï¼ŒCeph å¾ˆå¤šæ“ä½œéƒ½è¦è·¨ç¯€é»æ ¡å°ï¼Œåœ¨è¶…èåˆæ¡†æ¶ä¸­ CPU é‚„è¦æ‰¿æ“”å…¶ä»–æ¥­å‹™ï¼Œæ‰€ä»¥ä¸€å®šçš„ç©ºé–’æ ¸å¿ƒæ•¸æ¯”è¼ƒé‡è¦ï¼Œä½†å¯æ”¾å¿ƒï¼Œç¾ä»£æ¶ˆè²»ç´šä¸­é«˜ç«¯ CPU å®Œå…¨èƒ½æ»¿è¶³éœ€æ±‚ï¼Œä¸¦ä¸éœ€è¦ç‰¹åˆ¥èª‡å¼µçš„æœå‹™å™¨ç¡¬ä»¶ï¼›
- ç‰¹åˆ¥æ³¨æ„å…§å­˜ï¼Œé«˜æ€§èƒ½ç¶²çµ¡å­˜å„²éœ€è¦ç·©å­˜å¾ˆå¤šç´¢å¼•å’Œæ•¸æ“šï¼Œç‰¹åˆ¥æ˜¯å…ƒæ•¸æ“šæ˜ å°„ï¼Œè‡³å°‘è¦ç‚º Monitor é€²ç¨‹é ç•™ 4GB å…§å­˜ï¼Œæ›´å¤§çš„é›†ç¾¤å¯èƒ½è¦ 8GBã€16GB ç”šè‡³æ›´å¤šï¼›
- å°æ–¼å­˜å„²ç¯€é»ï¼Œæ ¹æ“šæ¯å€‹ OSD æ‰€ç®¡ç†çš„æ•¸æ“šå¤§å°ï¼Œç†æƒ³æƒ…æ³ä¸‹ 1TB æ•¸æ“šéœ€è¦ 1GB å…§å­˜ä»¥æ»¿è¶³å„ç¨®è¨ªå•è«‹æ±‚ï¼Œè‹¥ç¯€é»ä¸Šæœ‰ 10TB SSD å°±éœ€è¦é ç•™ 10GB å…§å­˜ä¾†ä¿éšœé›†ç¾¤æ•ˆç‡ã€‚

### MON ç¯€é»å€‹æ•¸é¸æ“‡

Monitor ç¯€é»è‡³å°‘éœ€è¦ 3 å€‹ï¼Œé€™æ˜¯å› ç‚º Ceph é›†ç¾¤é€šé paxos å”è­°ä¾†å–å¾—ä¸€è‡´æ€§ï¼Œè‡³å°‘éœ€è¦ 3 å€‹ç¯€é»ç¢ºä¿å¯ç”¨ï¼Œå®ƒå…·é«”è¦å‰‡æ˜¯ï¼š

```
vote_threshold = floor(N / 2 + 1)
```

å¦‚æœæ˜¯ 2 å€‹ç¯€é»ï¼Œé‚£éº¼ `floor(2 / 2 + 1) = 2`ï¼Œä¹Ÿå°±æ˜¯èªªï¼Œä»»ä½•ä¸€å€‹ç¯€é»æ›æ‰ï¼Œéƒ½æ²’è¾¦æ³•å–å¾—ä¸€è‡´ï¼Œé›†ç¾¤æœƒå¡ä½ï¼Œç­‰å¾…æ•…éšœç¯€é»é‡æ–°ä¸Šç·šæ‰æœƒæ¢å¾©ã€‚å¦å¤–æœ€ä½³å¯¦è¸æ˜¯é¸æ“‡å¥‡æ•¸ä½œç‚ºç¯€é»æ•¸ï¼Œé¿å…å› ç‚ºè…¦è£‚ç­‰åŸå› å°è‡´é‡çµ„ä¹‹å¾ŒæŠ•ç¥¨å¤±æ•—ï¼Œå°æ–¼å®¶ç”¨é›†ç¾¤ 3 å€‹ç¯€é»å·²è¶³å¤ ã€‚5 å€‹ç¯€é»å¯ä»¥æä¾›å¤šé›¢ç·šä¸€å€‹ç¯€é»çš„ä¿éšœï¼Œä½†æ‰€å¢åŠ çš„é–‹éŠ·å°æ–¼ homelab è¦æ¨¡é›†ç¾¤å¯èƒ½ä¸åˆ’ç®—ï¼Œå› ç‚º5å€‹ç¯€é»æœƒå°è‡´ç¶²çµ¡ä¸Šå¿ƒè·³åŒ…çš„é–‹éŠ·æ›´å¤§ï¼Œå°æ•´é«”ç¡¬ä»¶çš„è¦æ±‚æœƒæ›´é«˜ã€‚

### MDS ç¯€é»å€‹æ•¸é¸æ“‡

- CephFS è‡³å°‘éœ€è¦ 1 å€‹ MDS ç¯€é»ä¾†æä¾›å…ƒæ•¸æ“šæœå‹™ä¾†æ”¯æŒ POSIX å…¼å®¹çš„æ–‡ä»¶ç³»çµ±ï¼›
- MDS æœå‹™å™¨å€‹æ•¸é¸æ“‡ä¸éœ€è¦è€ƒæ…®ä¸€è‡´æ€§æŠ•ç¥¨å•é¡Œï¼Œä½†è¦æ³¨æ„åœ¨å°å‹é›†ç¾¤è£¡é¢ Ceph åªæœƒåœ¨ä¸€å€‹æ™‚é–“å…§é¸æ“‡æ¿€æ´»ä¸€å€‹ MDS ç¯€é»ï¼Œæ‰€ä»¥æ›´å¤šç¯€é»ä¸¦ä¸æœƒå¸¶ä¾†æ€§èƒ½æå‡ï¼Œä½†æœƒå¸¶ä¾†å¯ç”¨æ€§å†—ä½™ï¼Œå› ç‚ºéœ€è¦è€ƒæ…®å¦‚æœ MDS æ‰€åœ¨çš„ç¯€é» Down æ‰æˆ–è€…éœ€è¦ç¶­è­·ï¼Œé›†ç¾¤è£¡é¢çš„æ•¸æ“šä¾ç„¶å¯è¨ªå•ï¼Œæˆ‘åœ¨æ¯å€‹ç¯€é»ä¸Šéƒ½é–‹å•Ÿäº† MDSï¼Œé€™æ˜¯ä¸€å€‹éåº¦éƒ¨ç½²çš„é¸æ“‡ï¼Œå¯ä»¥è®“æˆ‘éš¨ä¾¿ä¸‹ç·šç¯€é»ä¾†ç¶­è­·ï¼Œæ¯”è¼ƒæ–¹ä¾¿ã€‚

### Ceph çš„ç©ºé–“è¨ˆç®—

![Ceph](./assets/Screenshot%202025-02-18%20at%201.39.25â€¯AM.png)

ç‚ºä»€éº¼`reweight`å¾ˆé‡è¦ï¼Œå› ç‚ºå®ƒæœƒå½±éŸ¿ Ceph é›†ç¾¤çš„å¯¦éš›å¯ç”¨ç©ºé–“ï¼Œä¸‹é¢å…ˆä»‹ç´¹ä¸€ä¸‹ Ceph å¦‚ä½•è¨ˆç®—ç©ºé–“ã€‚ç”±æ–¼ Ceph çš„å‰¯æœ¬å†—é¤˜ç­–ç•¥ï¼Œé›†ç¾¤çš„ç†è«–å¯ç”¨ç©ºé–“æ˜¯é€šéä»¥ä¸‹å…¬å¼è¨ˆç®—å‡ºä¾†çš„ï¼š

```
total_space = sum(OSD_Capacity) / size
```

ä¹Ÿå°±æ˜¯æ‰€æœ‰ OSD çš„å®¹é‡åŠ èµ·ä¾† / å‰¯æœ¬æ•¸ã€‚å°æ–¼å‡å‹»é›†ç¾¤ï¼ˆå–®å€‹ç¯€é»ç£ç›¤å¤§å°ä¸€è‡´ï¼Œæ¯å€‹ç¯€é»ç£ç›¤æ•¸ä¹Ÿä¸€è‡´ï¼‰ï¼Œä¸Šé¢çš„å…¬å¼ç­‰åƒ¹æ–¼ï¼š

```
total_space = OSD_Capacity * OSD_num / size
```

åœ¨ PVE Ceph ç®¡ç†é é¢çœ‹åˆ°çš„é›†ç¾¤å®¹é‡ï¼Œå°±æ˜¯ä¸Šé¢å…¬å¼è¨ˆç®—çš„ç†è«–å®¹é‡ã€‚é‚£éº¼å·²ç¶“å¯«å…¥çš„æ•¸æ“šé«”ç©ï¼Œæ˜¯å¦‚ä½•è¨ˆç®—çš„å‘¢ï¼Ÿç‚ºä»€éº¼æˆ‘åªå‰µå»ºäº†ä¸€å€‹ 1TB çš„ VMï¼Œä½†æ˜¯å»ä½”ç”¨äº†å¹¾ TBï¼Ÿé€™æ˜¯å› ç‚º Ceph çš„ç©ºé–“è¨ˆç®—æ˜¯è€ƒæ…®äº†å‰¯æœ¬æ•¸é‡ï¼Œä¹Ÿå°±æ˜¯æ•¸æ“šé«”ç©åŠ ç¸½ * å‰¯æœ¬æ•¸ï¼š

```
used_space = sum(data_size) * size
```

é€™å’Œ RAID ä¸ä¸€æ¨£ï¼ŒRAID æ˜¯çµ„æˆé™£åˆ—å¾Œæ¸›å»å†—ä½™æè€—å¾—åˆ°çš„å¯¦éš›å¯ç”¨å®¹é‡ï¼ŒRAID çš„æ•¸æ“šé«”ç©æ˜¯æ•¸æ“šçš„å¯¦éš›é«”ç©ï¼Œä¸è€ƒæ…®å†—ä½™å’Œç³¾éŒ¯ã€‚

ç†è«–ä¸Šï¼Œé›†ç¾¤èªç‚ºæ¯å€‹ç¯€é»å¯å¯«å…¥å®¹é‡ä¸€è‡´ï¼Œåœ¨é»˜èª`reweight = 1`çš„æƒ…æ³ä¸‹ï¼ŒCeph å¯«å…¥æ™‚æ¯å€‹ç¯€é»æ¯å€‹ OSD éƒ½æœ‰å‡ç­‰æ©Ÿæœƒä¾†æ¥å—å¯«å…¥ï¼Œé€™å°±æ˜¯æ‰€è¬‚çš„å‡å‹»é›†ç¾¤ã€‚

### OSD æ˜¯å¦éœ€è¦çµ±ä¸€å¤§å°çš„ç£ç›¤ï¼Ÿ

ç¹¼çºŒä¸Šé¢çš„è¨è«–ï¼Œå¦‚æœç¯€é»ä¸å‡å‹»ï¼ŒæŸäº›å°ç£ç›¤æœƒæ›´å¿«å¯«æ»¿ï¼Œå°è‡´é›†ç¾¤éæ—©æ‹’çµ•å¯«å…¥ã€‚é‚£éº¼æ˜¯å¦ä¸€å®šè¦æ§‹å»ºå‡å‹»é›†ç¾¤ï¼Ÿä¹Ÿä¸æ˜¯ï¼Œé€™ä¹Ÿæ˜¯å¤§éƒ¨åˆ†ç§‘æ™®æ–‡ç« çš„éŒ¯èª¤æ‰€åœ¨ã€‚äº‹å¯¦ç•°æ§‹ç£ç›¤çµ„æˆ Ceph é›†ç¾¤ï¼Œä¾ç„¶é«˜æ•ˆå¯é ï¼Œä½†æ‡‰ä¿æŒæ¯å€‹ç¯€é»çš„ç£ç›¤åŠ èµ·ä¾†å®¹é‡ç›¸è¿‘ã€‚å¦å‰‡æœƒé€ æˆå¤§å®¹é‡ç¯€é»é‚„æ²’æ»¿ï¼Œå°å®¹é‡ç¯€é»å ±è­¦å¯«æ»¿ï¼Œé€ æˆç©ºé–“æµªè²»ã€‚å°æ–¼å°ºå¯¸ä¸ä¸€è‡´çš„ OSDï¼Œå¯ä»¥é€šé`reweight`èª¿æ•´æ¬Šé‡ï¼Œé€™æ¨£å¯ä»¥è®“å¤§å®¹é‡ç£ç›¤æ‰¿æ“”æ›´å¤šæ•¸æ“šï¼Œå°å®¹é‡ç£ç›¤æ‰¿æ“”æ›´å°‘æ•¸æ“šï¼Œä¿è­‰æ¯å€‹ç£ç›¤çš„åˆ©ç”¨ç‡å¤§è‡´å‡å‹»ï¼ŒåŒæ™‚æœ€å¤§åŒ–é›†ç¾¤å¯ç”¨å®¹é‡ã€‚

è‡¨æ™‚`reweight`å‘½ä»¤ï¼Œå…¶ä¸­`OSD_ID`æ˜¯ OSD çš„æ•¸å­— IDï¼Œå¦‚`osd.1`ï¼Œåªéœ€è¦è¼¸å…¥`1`å³å¯ï¼Œ`REWEIGHT_VALUE`æ˜¯é‡æ¬Šå€¼ï¼Œé»˜èªæ˜¯`1`ï¼Œè¶Šå¤§è¡¨ç¤ºæ‰¿æ“”çš„æ•¸æ“šè¶Šå¤šï¼Œæœ‰æ•ˆç¯„åœæ˜¯ä¸€å€‹`0`åˆ°`1`ä¹‹é–“çš„æµ®é»æ•¸ï¼Œæ³¨æ„ç›´æ¥åŸ·è¡Œ`reweight`å‘½ä»¤æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œç•¶ç£ç›¤é‡æ–°ä¸Šç·šï¼ˆinï¼‰æ™‚`reweight`å€¼æœƒè¢«é‡ç½®ç‚º`1`ï¼š

```bash
# ceph osd reweight [OSD_ID] [REWEIGHT_VALUE]
```

æŒä¹…åŒ–é…ç½®è¦é€šéä»¥ä¸‹å‘½ä»¤å¯«å…¥`CRUSH map`ï¼Œå…¶ä¸­`OSD_NAME`æ˜¯ OSD çš„å®Œæ•´åå­—ï¼Œå’Œä¸Šé¢çš„`OSD_ID`ä¸ä¸€æ¨£ï¼Œå®ƒåŒ…å«å‰é¢çš„`osd.`å‰ç¶´ï¼Œå¦‚`osd.1`ï¼Œ`REWEIGHT_VALUE`çš„å®šç¾©å’Œå‰æ–‡ä¿æŒä¸€è‡´ï¼Œé€™è£¡æåˆ°`CRUSH map`æ˜¯ Ceph çš„æ ¸å¿ƒæ•¸æ“šåˆ†ä½ˆç­–ç•¥ï¼Œå¾Œé¢æœƒè©³ç´°ä»‹ç´¹ï¼š

```bash
# ceph osd crush reweight [OSD_NAME] [REWEIGHT_VALUE]
```

ä¹Ÿå¯ä»¥è‡ªå‹•æ ¹æ“š osd åˆ©ç”¨ç‡ä¾†èª¿æ•´`reweight`ï¼Œé€™æ¨£å¯ä»¥ä¿è­‰æ¯å€‹ç£ç›¤çš„åˆ©ç”¨ç‡å¤§è‡´ç›¸åŒï¼Œ`THRESHOLD`æ˜¯å¯é¸é–¾å€¼ï¼Œé»˜èª`120`ï¼Œè¡¨ç¤ºå¦‚æœç£ç›¤åˆ©ç”¨ç‡è¶…éé›†ç¾¤å¹³å‡åˆ©ç”¨ç‡çš„`120%`ï¼Œå‰‡é€²è¡Œ`reweight`ï¼š

Dry run:

```bash
# ceph osd test-reweight-by-utilization [THRESHOLD]
```

Apply:

```bash
# ceph osd reweight-by-utilization [THRESHOLD]
```

é‚„è‡ªå‹•æ ¹æ“š PG æ•¸é‡ä¾†èª¿æ•´`reweight`ï¼Œé€™æ¨£å¯ä»¥ä¿è­‰æ¯å€‹ç£ç›¤çš„ PG æ•¸é‡å¤§è‡´ç›¸åŒï¼Œ`THRESHOLD`æ˜¯å¯é¸é–¾å€¼ï¼Œé»˜èªæ˜¯`120`ï¼Œè¡¨ç¤ºå¦‚æœç£ç›¤çš„ PG æ•¸è¶…éé›†ç¾¤å¹³å‡ PG æ•¸é‡çš„`120%`ï¼Œå‰‡é€²è¡Œ reweightï¼š

Dry run:

```bash
# ceph osd test-reweight-by-pg [THRESHOLD]
```

Apply:

```bash
# ceph osd reweight-by-pg [THRESHOLD]
```

### PG å€‹æ•¸é¸æ“‡

PG æ•¸æœƒå½±éŸ¿ Ceph çš„æ€§èƒ½å’Œæ•¸æ“šåˆ†ä½ˆçš„å‡å‹»ç¨‹åº¦ï¼š

- åŒç­‰æ•¸æ“šé«”ç©ä¸‹ï¼ŒPG æ•¸è¶Šå¤šï¼Œæ•¸æ“šè¶Šå®¹æ˜“å‡å‹»åˆ†ä½ˆï¼Œç†è«–ä¸Šåˆ†ä½ˆå¼è¨ªå•æ€§èƒ½æ›´é«˜ï¼Œä½†æ˜¯éå¤š PG æœƒå°è‡´å…ƒæ•¸æ“šéå¤§ï¼Œå½±éŸ¿æ€§èƒ½ï¼›
- åéä¾†å¦‚æœ PG æ•¸é‡éå°ï¼Œæ•¸æ“šåˆ†ä½ˆä¸å‡å‹»ï¼Œæœƒå°è‡´æŸäº› OSD è² æ“”éé‡ï¼Œå½±éŸ¿é›†ç¾¤ç©©å®šæ€§ã€‚

æ¯å€‹å­˜å„²æ± éœ€è¦å¤šå°‘å€‹ PGï¼Œé€šå¸¸å¯ç”¨ä»¥ä¸‹å…¬å¼è¨ˆç®—ï¼š

```
PG_num = (OSD_num * [OSD_TARGET_PG_NUM]) / (pool_num * size)
```

å…¶ä¸­ï¼š

- `OSD_num`æ˜¯é›†ç¾¤ä¸­ OSD ç¸½æ•¸ï¼›
- `OSD_TARGET_PG_NUM`æ˜¯æ¯å€‹ OSD çš„ç›®æ¨™ PG æ•¸ï¼Œå»£æ³›æ¥å—çš„ç¶“é©—ä¸Šæœ€ä½³å¯¦è¸å€¼æ˜¯ 100ï¼›
- `pool_num`æ˜¯å­˜å„²æ± æ•¸é‡ï¼›
- `size` æ˜¯å‰¯æœ¬æ•¸

çµæœä¸€èˆ¬æœƒå–ä¸€å€‹æœ€è¿‘çš„`2 çš„å†ª`ä½œç‚º PG æ•¸ï¼Œé€™æ¨£å¯ä»¥ä¿è­‰å°‡ä¾†é‡æ–°åˆ†é…æ™‚ PG æ›´å®¹æ˜“å‡å‹»åˆ†ä½ˆã€‚

ä¾‹å¦‚æˆ‘çš„é›†ç¾¤æ¯å€‹ç¯€é» 5 å€‹ SSDï¼Œä¸€å…± 4 å€‹ç¯€é»ï¼Œå‰¯æœ¬æ•¸æ˜¯ 4ï¼Œæœ‰ 4 å€‹å­˜å„²æ± ï¼Œé‚£éº¼ï¼š

```
PG_num = (4 * 5 * 100) / (2 * 4) = 250 ï½= 256 (2^8)
```

å·æ‡¶çš„è©±ä¹Ÿå¯ä»¥ç›´æ¥è¨ªå• PVE Ceph ç®¡ç†ä»‹é¢ï¼Œæ‰¾åˆ°`Optimal # of PGs`ï¼Œç›´æ¥å¯«åˆ°å°æ‡‰å­˜å„²æ±  PG æ•¸é…ç½®ä¸Šã€‚

é€™è£¡é¡å¤–èªªä¸€ä¸‹å¹¾å€‹å¸¸ç”¨çš„é…ç½®ï¼š

- PG Auto Scaleï¼šè‡ªå‹•èª¿æ•´ PG æ•¸é‡ï¼Œæ ¹æ“šé›†ç¾¤è² è¼‰è‡ªå‹•èª¿æ•´ PG æ•¸ï¼Œå»ºè­°æ‰“é–‹ï¼›
- Target Ratioï¼šç›®æ¨™ä½”æ¯”ï¼ŒæŒ‡ç•¶å‰å­˜å„²æ± æœƒè‡ªå‹•æ“´å±•ï¼Œä¸€ç›´é”åˆ°ä½”ç”¨æ•´é›†ç¾¤ç©ºé–“çš„ç›®æ¨™ä½”æ¯”ç‚ºæ­¢ï¼›
- Target Max PGï¼šæœ€å¤§ PG å°ºå¯¸ï¼ŒæŒ‡ç•¶ PG æ•¸æ“šè¶…éæ­¤å°ºå¯¸ï¼Œå°‡æœƒè‡ªå‹•é€²è¡Œé‡åˆ†é…åˆ°æ–°çš„ PG ä¸Šï¼›
- Min. # of PGsï¼šé€™å€‹å­˜å„²æ± æœ€å°‘ä½”ç”¨å¤šå°‘å€‹ PGï¼Œé»˜èªç‚º 0ã€‚

### é—œæ–¼ CRUSH map

å¹¾ä¹æ‰€æœ‰ Ceph çš„é‡è¦é…ç½®éƒ½å¯ä»¥é€šéä¿®æ”¹ CRUSH map ä¾†å¯¦ç¾ï¼Œå®ƒæ§åˆ¶æ•¸æ“šåˆ†é…ç­–ç•¥ï¼Œä½ å¯ä»¥åœ¨ PVE çš„ Ceph ç®¡ç†ä»‹é¢ä¸Šçœ‹åˆ° CRUSH map è©³æƒ…ã€‚ä½ å¯ä»¥æ”¾å¿ƒä¿®æ”¹ CRUSH mapï¼ŒCeph æœƒæ ¹æ“šæ–°ç‰ˆæœ¬çš„ CRUSH map é‡æ–°å¹³è¡¡æ•¸æ“šåˆ†ä½ˆï¼Œæ•´å€‹éç¨‹åœ¨ç·šå®Œæˆç„¡éœ€åœæ©Ÿï¼Œä¸å½±éŸ¿æ¥­å‹™ï¼Œä¸”æ•ˆç‡å¾ˆé«˜ã€‚

å› æ­¤å…¶å¯¦ä½ å¯ä»¥éš¨æ„å¾€é›†ç¾¤è£¡é¢æ·»åŠ åˆªé™¤ OSDï¼Œç„¶å¾Œä¿®æ”¹ CHUSH map è®“æ•¸æ“šè‡ªå‹•å¹³è¡¡ã€‚é€™æ˜¯æˆ‘æœ€å–œæ­¡ Ceph çš„åœ°æ–¹ï¼Œæ¯”ä»»ä½•ç£ç›¤é™£åˆ—éƒ½æ–¹ä¾¿ï¼Œä»»ä½•ç£ç›¤é™£åˆ—åšé€™é¡æ“ä½œéƒ½ç„¡æ³•åšåˆ°é€™éº¼å¹³æ»‘ã€‚

ä¸€äº›å¸¸ç”¨çš„ CRUSH map é…ç½®ï¼š

- `min_size`ï¼šæœ€å°å‰¯æœ¬æ•¸ï¼Œé»˜èªç‚º 1ï¼›
    > æ­¤å€‹è¨­ç½®å„ªå…ˆç´šä½æ–¼å­˜å„²æ± é…ç½®ã€‚
- `max_size`ï¼šæœ€å¤§å‰¯æœ¬æ•¸ï¼Œé»˜èªç‚º 10ï¼›
    > æ­¤å€‹è¨­ç½®å„ªå…ˆç´šä½æ–¼å­˜å„²æ± é…ç½®ã€‚
- `step take default class [CLASS-NAME]`ï¼šå„ªå…ˆé¸æ“‡ä½•ç¨®é¡å‹çš„ OSDï¼Œå¦‚ `hdd`ï¼Œ`ssd`ï¼Œ`nvme` ç­‰ã€‚
    > å°æ–¼è¦æŒ‰ä»‹è³ªåˆ†é… OSD åˆ°ä¸åŒçš„å­˜å„²æ± ï¼Œå¦‚ SSD æ± ã€HDD æ± ç­‰éå¸¸æœ‰ç”¨ã€‚

ä»‹ç´¹ä¸€ä¸‹ä¿®æ”¹ CRUSH map çš„åŸºæœ¬æ­¥é©Ÿï¼š

#### 1. ç²å¾— CRUSH map äºŒé€²åˆ¶æ–‡ä»¶

```bash
# ceph osd getcrushmap -o crushmap.compiled
```

#### 2. è§£ç¢¼ CRUSH map æ–‡ä»¶

```bash
$ crushtool -d crushmap.compiled -o crushmap.text
```

#### 3. ä¿®æ”¹ CRUSH map æ–‡ä»¶

```bash
$ vim crushmap.text
```

#### 4. ç·¨ç¢¼ CRUSH map æ–‡ä»¶

```bash
$ crushtool -c crushmap.text -o crushmap.compiled.new
```

#### 5. æ¸¬è©¦æ–°çš„ CRUSH map äºŒé€²åˆ¶æ–‡ä»¶ï¼ˆå¯é¸ï¼‰

```bash
# crushtool -i crushmap.compiled.new --test --show-X
```

#### 6. æ‡‰ç”¨æ–°çš„ CRUSH map äºŒé€²åˆ¶æ–‡ä»¶

```bash
# ceph osd setcrushmap -i crushmap.compiled.new
```

## é‚å‘é«˜å¯ç”¨

æ‰€è¬‚å°é›†ç¾¤æœå‹™çš„é«˜å¯ç”¨ï¼Œé™¤äº†ç¶²çµ¡æœ¬èº«è¦æœ‰å†—ä½™ï¼Œé›»æºæ–¹æ¡ˆè¦æœ‰ UPS å’Œç™¼é›»æ©Ÿä¹‹å¤–ï¼ˆæ˜¯çš„ï¼Œæˆ‘æœ‰ç™¼é›»æ©Ÿï¼‰ï¼ŒVM èƒ½è‡ªå‹•å¾æ•…éšœçš„ç‰©ç†ç¯€é»ä¸­é·ç§»å’Œé‡å»ºå¾ˆé‡è¦ã€‚PVE é›†ç¾¤å¯ä»¥é€šé`HA (High Availability)`é¢æ¿ä¾†é…ç½®ï¼Œå‰ææ˜¯ä¸Šé¢æåˆ°çš„ PVE é›†ç¾¤ã€Cephé›†ç¾¤éƒ½å·²æ­£ç¢ºé…ç½®ã€‚

- æ‰¾åˆ°`HA`ç®¡ç†é é¢ï¼Œå‰µå»º`lrm`ç¯€é»ï¼›
    > å¯ä»¥åœ¨æ‰€æœ‰çš„ç¯€é»ä¸Šé–‹å•Ÿ lrm æœå‹™ã€‚
- å‰µå»º`HA Group`ï¼Œå¦‚æœ VM å°ç¡¬ä»¶æ²’æœ‰ç‰¹åˆ¥éœ€æ±‚ï¼Œå¯å¿½ç•¥é€™ä¸€æ­¥ï¼›
    > å¦‚æœä½ çš„æ¥­å‹™éœ€è¦ä¸åŒçš„è³‡æºçµ„åˆï¼Œä¾‹å¦‚ä½ æœ‰å…©å€‹å¤§å…§å­˜çš„ç¯€é»ï¼Œå…©å€‹å°å…§å­˜çš„ç¯€é»ï¼Œä½ æ‡‰è©²æŠŠå¤§å°å…§å­˜çš„ç¯€é»åŠƒåˆ†ç‚ºå…©å€‹è³‡æºçµ„ï¼Œé€™æ¨£å¯ä»¥ä¿è­‰å°å…§å­˜ä¾è³´é«˜çš„ VM èƒ½é·ç§»åˆ°é©åˆçš„ç¯€é»ä¸Šï¼Œé¡ä¼¼åœ°ä¹Ÿéœ€è¦æŠŠæœ‰é¡¯å¡çš„æ©Ÿå™¨ç·¨æˆä¸€å€‹çµ„ï¼Œä½†æ˜¯é¡¯å¡æ¯”è¼ƒç‰¹æ®Šï¼Œå¾Œé¢æˆ‘æœƒå†è£œå……ã€‚
- åœ¨`HA Resource`é¢æ¿æ·»åŠ éœ€è¦ä½œç‚ºé«˜å¯ç”¨æœå‹™çš„ VMã€‚
    > é¸æ“‡ VM å’Œå°æ‡‰çš„`HA Group`ï¼ˆå¦‚éœ€è¦ï¼‰ï¼Œé…ç½®`Max. Restart`ï¼ˆæœ€å¤§çš„è‡ªå‹•é‡å•Ÿæ¬¡æ•¸ï¼‰å’Œ`Max. Relocate`ï¼ˆæœ€å¤§é·ç§»æ¬¡æ•¸ï¼‰ï¼ŒæŒ‰æ·»åŠ å³å¯ã€‚

æ¸¬è©¦ï¼Œé…ç½®æˆåŠŸä¹‹å¾Œï¼Œåœ¨ VM æ‰€åœ¨çš„ç¯€é»ä¸Šæ‹”å‡ºç¶²ç·šï¼ŒVM æ‡‰è©²æœƒè‡ªå‹•é·ç§»åˆ°å…¶ä»–æ©Ÿå™¨ä¸Šé‹è¡Œï¼Œå¦‚å‡ºéŒ¯ï¼Œå¯æŸ¥çœ‹`cluster log`é€²è¡Œæ’æŸ¥ã€‚

### é—œæ–¼é¡¯å¡ä»¥åŠå…¶ä»–æœ‰ç›´é€šç¡¬ä»¶ä¾è³´çš„é«˜å¯ç”¨é…ç½®

æœ‰ä¸€äº›æ¥­å‹™ä¾è³´ GPU æˆ–è€…å…¶ä»–ç¡¬ä»¶ï¼Œé€™äº› VM åœ¨è‡ªå‹•é·ç§»ä¹‹å¾Œï¼Œéœ€è¦æ‰¾åˆ°åŠŸèƒ½å¯æ›¿ä»£çš„ç¡¬ä»¶æ‰èƒ½æ­£å¸¸é‹è¡Œã€‚é€™ä¸€é¡çš„ VM éœ€è¦ä¸€äº›é¡å¤–çš„é…ç½®æ­¥é©Ÿä¾†å¯¦ç¾é«˜å¯ç”¨ï¼š

- åœ¨ PVE é…ç½®é é¢ä¸Šæ‰¾åˆ°`Resource Mappings`å‰µå»ºä¸€å€‹ PCI / USB è³‡æºçµ„ï¼Œå¦‚ GPU çµ„ï¼Œç„¶å¾ŒæŠŠæŸä¸€å€‹ç¯€é»ä¸Šçš„ GPU åŠ å…¥é€™å€‹ PCI è³‡æºçµ„ï¼›
- åœ¨è³‡æºçµ„ Actions åˆ—ä¸­æ‰¾åˆ°`+`åŠ è™Ÿï¼Œæ·»åŠ å…¶ä»–ç¯€é»ä¸Šçš„å…¼å®¹è³‡æºï¼Œé€šå¸¸ç‚ºå¦ä¸€å€‹ç¯€é»ä¸Šçš„ GPUï¼›
- ä¿®æ”¹ VM é…ç½®ï¼Œåˆªé™¤åŸºæ–¼ PCI åœ°å€çš„ç¡¬ä»¶ï¼Œé‡æ–°æ·»åŠ ä¸Šé¢ç¶å®šçš„æ˜ å°„ç¡¬ä»¶ï¼›
- å‰µå»ºä¸€å€‹å’Œ`Resource Mappings`å°æ‡‰çš„`HA Group`ï¼›
- åœ¨`HA Resource`é¢æ¿ï¼Œæ·»åŠ éœ€è¦é«˜å¯ç”¨çš„ VM å’Œå°æ‡‰çš„è³‡æºçµ„ã€‚

é€™æ¨£é…ç½®ä¹‹å¾Œï¼ŒVM åœ¨é·ç§»çš„æ™‚å€™ï¼Œæœƒè‡ªå‹•é·ç§»åˆ°æœ‰ç›¸æ‡‰ç¡¬ä»¶è³‡æºçš„ç¯€é»ä¸Šã€‚

## å‚™ä»½æ–¹æ¡ˆ

PBSï¼ˆProxmox Backup Serverï¼‰æ˜¯ PVE çš„è¡ç”Ÿé …ç›®ï¼Œæ˜¯é‡å° PVE è¨­è¨ˆçš„åŸç”Ÿå‚™ä»½æ–¹æ¡ˆã€‚å®ƒå¾ˆå®¹æ˜“æ•´åˆåˆ° PVE é›†ç¾¤ä¸Šï¼Œä½œç‚ºå‚™ä»½æœå‹™çš„å»¶ä¼¸ï¼Œæä¾›å¾å®¹å™¨åˆ° VMï¼Œç”šè‡³ç‰©ç†ä¸»æ©Ÿçš„å®Œæ•´å‚™ä»½æ–¹æ¡ˆã€‚

### å®‰è£ PBS

æœ‰å¤šç¨®æ–¹æ³•å®‰è£ PBSï¼Œå¯ä»¥ç›´æ¥å¾[å®˜ç¶²ä¸‹è¼‰](https://www.proxmox.com/en/downloads/proxmox-backup-server)å•Ÿå‹•é¡åƒï¼ŒDD åˆ° U ç›¤ä¸Šï¼Œç›´æ¥å®‰è£æˆä¸€å€‹ç¨ç«‹çš„å‚™ä»½æœå‹™å™¨ã€‚ä¹Ÿå¯[åœ¨ Debian / PVE ä¸Šå®‰è£](https://pbs.proxmox.com/docs/installation.html#debian-package-repositories)ï¼Œä»¥ä¸‹è©³ç´°èªªä¸€ä¸‹é€™ç¨®æ–¹å¼ï¼Œä¹Ÿæ˜¯æˆ‘æ‰€ä½¿ç”¨çš„å®‰è£æ–¹å¼ã€‚æ³¨æ„ PVE å’Œ PBS å¯ä»¥ç¨ç«‹å®‰è£ä¹Ÿå¯ä»¥å’Œè«§å…±å­˜åˆ°ä¸€å€‹ä¸»æ©Ÿä¸Šï¼Œç•¶ç„¶æœ‰æ¢ä»¶çš„è©±ï¼Œé‚„æ˜¯æ¨è–¦ç¨ç«‹ä¸€å€‹å‚™ä»½æœå‹™å™¨ï¼Œä½†åŸºæ–¼è³‡æºåˆ©ç”¨çš„è€ƒæ…®ï¼Œæˆ‘é¸æ“‡äº†æŠŠ PBS å®‰è£åˆ°ä¸€å€‹å­˜å„²è³‡æºå¯Œè£•çš„ PVE ç¯€é»ä¸Šã€‚

#### 1. ç²å¾— PBS APT æºçš„å¯†é‘°ï¼š

```bash
# wget https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
```

#### 2. é©—è­‰å¯†é‘°ï¼š

```bash
$ sha512sum /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
7da6fe34168adc6e479327ba517796d4702fa2f8b4f0a9833f5ea6e6b48f6507a6da403a274fe201595edc86a84463d50383d07f64bdde2e3658108db7d6dc87  /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
```

#### 3. æ·»åŠ  APT æºï¼š

```bash
# vim /etc/apt/sources.list.d/pbs.list
```

å°æ–¼ä»˜è²»ç”¨æˆ¶ï¼š

```sources.list
deb https://enterprise.proxmox.com/debian/pbs bookworm pbs-enterprise
```

å°æ–¼å…è²»ç”¨æˆ¶ï¼š

```sources.list
deb http://download.proxmox.com/debian/pbs bookworm pbs-no-subscription
```

å°æ–¼ä¸æ€•æ­»çš„åšé®®ç”¨æˆ¶ï¼š

```sources.list
deb http://download.proxmox.com/debian/pbs bookworm pbstest
```

å°æ–¼åªéœ€è¦å‚™ä»½å®¢æˆ¶ç«¯ï¼Œä¸éœ€è¦å‚™ä»½æœå‹™å™¨çš„ç”¨æˆ¶ï¼š

```sources.list
# for Debian Bookworm
deb http://download.proxmox.com/debian/pbs-client bookworm main

# for Debian Bullseye
deb http://download.proxmox.com/debian/pbs-client bullseye main

# for Debian Buster / Ubuntu 20.04 LTS
deb http://download.proxmox.com/debian/pbs-client buster main
```

#### 4. å®‰è£ PBS æœå‹™å™¨

```bash
# apt update
# apt install proxmox-backup-server
```

#### 5. å®‰è£ PBS å®¢æˆ¶ç«¯

```bash
# apt update
apt install proxmox-backup-client
```

--------------------------------------------------------------------------------

## æœªå®Œå¾…çºŒ

æŠ±æ­‰ï¼Œæˆ‘çš„ PBS æœå‹™æœ€è¿‘åœ¨åšå­˜å„²å‡ç´šï¼Œé™£åˆ—æ–‡ä»¶ç³»çµ±åœ¨å‡ç´šä¸­ï¼Œç­‰æœå‹™å™¨å‡ç´šå®Œæˆï¼Œæˆ‘æœƒç¹¼çºŒè£œå……é€™éƒ¨åˆ†å…§å®¹ã€‚

![btrfs](./assets_temp/Screenshot%202025-02-17%20at%206.28.59â€¯PM.png)
